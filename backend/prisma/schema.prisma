generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model admin_operation_logs {
  log_id                                           String   @id @default(uuid()) @db.VarChar(36)
  operator_id                                      String   @db.VarChar(36)
  target_user_id                                   String   @db.VarChar(36)
  action                                           String   @db.VarChar(50)
  description                                      String
  created_at                                       DateTime @default(now()) @db.Timestamp(6)
  users_admin_operation_logs_operator_idTousers    users    @relation("admin_operation_logs_operator_idTousers", fields: [operator_id], references: [user_id])
  users_admin_operation_logs_target_user_idTousers users    @relation("admin_operation_logs_target_user_idTousers", fields: [target_user_id], references: [user_id])

  @@index([created_at(sort: Desc)])
  @@index([operator_id])
  @@index([target_user_id])
}

model announcements {
  announcement_id String    @id @default(uuid()) @db.VarChar(36)
  title           String    @db.VarChar(200)
  content         String
  type            String    @default("normal") @db.VarChar(20)
  link_url        String?   @db.VarChar(500)
  is_top          Boolean   @default(false)
  start_time      DateTime? @db.Timestamp(6)
  end_time        DateTime? @db.Timestamp(6)
  status          Int       @default(1)
  created_at      DateTime  @default(now()) @db.Timestamp(6)
  updated_at      DateTime  @default(now()) @db.Timestamp(6)

  @@index([is_top])
  @@index([status])
}

model audit_logs {
  log_id      String     @id @default(uuid()) @db.VarChar(36)
  resource_id String?    @db.VarChar(36)
  auditor_id  String?    @db.VarChar(36)
  action      String     @db.VarChar(20)
  reason      String?
  created_at  DateTime   @default(now()) @db.Timestamp(6)
  users       users?     @relation(fields: [auditor_id], references: [user_id])
  resources   resources? @relation(fields: [resource_id], references: [resource_id])

  @@index([auditor_id])
  @@index([resource_id])
}

model banners {
  banner_id  String    @id @default(uuid()) @db.VarChar(36)
  title      String    @db.VarChar(100)
  image_url  String    @db.VarChar(500)
  link_url   String?   @db.VarChar(500)
  link_type  String?   @db.VarChar(20)
  sort_order Int       @default(0)
  start_time DateTime? @db.Timestamp(6)
  end_time   DateTime? @db.Timestamp(6)
  status     Int       @default(1)
  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime  @default(now()) @db.Timestamp(6)

  @@index([sort_order])
  @@index([status])
}

model categories {
  category_id      String       @id @default(uuid()) @db.VarChar(36)
  category_name    String       @db.VarChar(50)
  category_code    String       @unique @db.VarChar(50)
  parent_id        String?      @db.VarChar(36)
  icon             String?      @db.VarChar(500)
  sort_order       Int          @default(0)
  is_hot           Boolean      @default(false)
  is_recommend     Boolean      @default(false)
  resource_count   Int          @default(0)
  created_at       DateTime     @default(now()) @db.Timestamp(6)
  updated_at       DateTime     @default(now()) @db.Timestamp(6)
  categories       categories?  @relation("categoriesTocategories", fields: [parent_id], references: [category_id])
  other_categories categories[] @relation("categoriesTocategories")
  resources        resources[]

  @@index([parent_id])
  @@index([sort_order])
}

model daily_tasks {
  task_id       String       @id @default(uuid()) @db.VarChar(36)
  task_name     String       @db.VarChar(50)
  task_code     String       @unique @db.VarChar(50)
  task_type     String       @db.VarChar(20)
  points_reward Int
  target_count  Int          @default(1)
  description   String?
  is_enabled    Boolean      @default(true)
  sort_order    Int          @default(0)
  created_at    DateTime     @default(now()) @db.Timestamp(6)
  updated_at    DateTime     @default(now()) @db.Timestamp(6)
  user_tasks    user_tasks[]
}

model download_history {
  download_id String     @id @default(uuid()) @db.VarChar(36)
  user_id     String?    @db.VarChar(36)
  resource_id String?    @db.VarChar(36)
  points_cost Int        @default(0)
  ip_address  String?    @db.VarChar(50)
  user_agent  String?
  created_at  DateTime   @default(now()) @db.Timestamp(6)
  resources   resources? @relation(fields: [resource_id], references: [resource_id])
  users       users?     @relation(fields: [user_id], references: [user_id])

  @@index([created_at(sort: Desc)])
  @@index([resource_id])
  @@index([user_id])
}

model orders {
  order_id       String    @id @default(uuid()) @db.VarChar(36)
  order_no       String    @unique @db.VarChar(50)
  user_id        String?   @db.VarChar(36)
  order_type     String    @db.VarChar(20)
  product_type   String    @db.VarChar(20)
  product_name   String    @db.VarChar(100)
  amount         Decimal   @db.Decimal(10, 2)
  payment_method String?   @db.VarChar(20)
  payment_status Int       @default(0)
  transaction_id String?   @db.VarChar(100)
  paid_at        DateTime? @db.Timestamp(6)
  created_at     DateTime  @default(now()) @db.Timestamp(6)
  updated_at     DateTime  @default(now()) @db.Timestamp(6)
  // VIP支付系统扩展字段
  expire_at      DateTime? @db.Timestamp(6)
  cancelled_at   DateTime? @db.Timestamp(6)
  cancel_reason  String?   @db.VarChar(200)
  refund_status  Int       @default(0)
  callback_count Int       @default(0)

  users           users?            @relation(fields: [user_id], references: [user_id])
  vip_orders      vip_orders[]
  refund_requests refund_requests[]

  @@index([order_no])
  @@index([order_type])
  @@index([payment_status])
  @@index([user_id])
  @@index([expire_at])
}

model permissions {
  permission_id    String             @id @default(uuid()) @db.VarChar(36)
  permission_name  String             @db.VarChar(50)
  permission_code  String             @unique @db.VarChar(50)
  module           String             @db.VarChar(50)
  description      String?
  created_at       DateTime           @default(now()) @db.Timestamp(6)
  role_permissions role_permissions[]
}

model points_exchange_records {
  exchange_id      String           @id @default(uuid()) @db.VarChar(36)
  user_id          String?          @db.VarChar(36)
  product_id       String?          @db.VarChar(36)
  product_name     String           @db.VarChar(100)
  product_type     String           @db.VarChar(20)
  points_cost      Int
  delivery_status  Int              @default(0)
  delivery_address String?
  tracking_number  String?          @db.VarChar(100)
  created_at       DateTime         @default(now()) @db.Timestamp(6)
  updated_at       DateTime         @default(now()) @db.Timestamp(6)
  points_products  points_products? @relation(fields: [product_id], references: [product_id])
  users            users?           @relation(fields: [user_id], references: [user_id])

  @@index([delivery_status])
  @@index([user_id])
}

model points_products {
  product_id              String                    @id @default(uuid()) @db.VarChar(36)
  product_name            String                    @db.VarChar(100)
  product_type            String                    @db.VarChar(20)
  product_code            String                    @unique @db.VarChar(50)
  points_required         Int
  product_value           String?
  stock                   Int                       @default(-1)
  image_url               String?                   @db.VarChar(500)
  description             String?
  sort_order              Int                       @default(0)
  status                  Int                       @default(1)
  created_at              DateTime                  @default(now()) @db.Timestamp(6)
  updated_at              DateTime                  @default(now()) @db.Timestamp(6)
  points_exchange_records points_exchange_records[]

  @@index([product_type])
  @@index([status])
}

model points_records {
  record_id      String   @id @default(uuid()) @db.VarChar(36)
  user_id        String?  @db.VarChar(36)
  points_change  Int
  points_balance Int
  change_type    String   @db.VarChar(20)
  source         String   @db.VarChar(50)
  source_id      String?  @db.VarChar(36)
  description    String?
  created_at     DateTime @default(now()) @db.Timestamp(6)
  users          users?   @relation(fields: [user_id], references: [user_id])

  @@index([change_type])
  @@index([created_at(sort: Desc)])
  @@index([user_id])
}

model points_rules {
  rule_id      String   @id @default(uuid()) @db.VarChar(36)
  rule_name    String   @db.VarChar(50)
  rule_code    String   @unique @db.VarChar(50)
  rule_type    String   @db.VarChar(20)
  points_value Int
  description  String?
  is_enabled   Boolean  @default(true)
  created_at   DateTime @default(now()) @db.Timestamp(6)
  updated_at   DateTime @default(now()) @db.Timestamp(6)
}

model resources {
  resource_id                       String             @id @default(uuid()) @db.VarChar(36)
  title                             String             @db.VarChar(200)
  description                       String?
  cover                             String?            @db.VarChar(500)
  file_url                          String             @db.VarChar(500)
  file_name                         String             @db.VarChar(255)
  file_size                         BigInt
  file_format                       String             @db.VarChar(20)
  preview_images                    String[]
  category_id                       String?            @db.VarChar(36)
  tags                              String[]
  vip_level                         Int                @default(0)
  user_id                           String?            @db.VarChar(36)
  audit_status                      Int                @default(0)
  audit_msg                         String?
  auditor_id                        String?            @db.VarChar(36)
  audited_at                        DateTime?          @db.Timestamp(6)
  download_count                    Int                @default(0)
  view_count                        Int                @default(0)
  like_count                        Int                @default(0)
  collect_count                     Int                @default(0)
  is_top                            Boolean            @default(false)
  is_recommend                      Boolean            @default(false)
  status                            Int                @default(1)
  created_at                        DateTime           @default(now()) @db.Timestamp(6)
  updated_at                        DateTime           @default(now()) @db.Timestamp(6)
  audit_logs                        audit_logs[]
  download_history                  download_history[]
  users_resources_auditor_idTousers users?             @relation("resources_auditor_idTousers", fields: [auditor_id], references: [user_id])
  categories                        categories?        @relation(fields: [category_id], references: [category_id])
  users_resources_user_idTousers    users?             @relation("resources_user_idTousers", fields: [user_id], references: [user_id])
  user_favorites                    user_favorites[]

  @@index([audit_status])
  @@index([category_id])
  @@index([collect_count(sort: Desc)])
  @@index([created_at(sort: Desc)])
  @@index([download_count(sort: Desc)])
  @@index([like_count(sort: Desc)])
  @@index([status])
  @@index([user_id])
  @@index([vip_level])
}

model role_permissions {
  role_id       String      @db.VarChar(36)
  permission_id String      @db.VarChar(36)
  created_at    DateTime    @default(now()) @db.Timestamp(6)
  permissions   permissions @relation(fields: [permission_id], references: [permission_id], onDelete: Cascade)
  roles         roles       @relation(fields: [role_id], references: [role_id], onDelete: Cascade)

  @@id([role_id, permission_id])
  @@index([permission_id])
  @@index([role_id])
}

model roles {
  role_id          String             @id @default(uuid()) @db.VarChar(36)
  role_name        String             @unique @db.VarChar(50)
  role_code        String             @unique @db.VarChar(50)
  description      String?
  created_at       DateTime           @default(now()) @db.Timestamp(6)
  updated_at       DateTime           @default(now()) @db.Timestamp(6)
  role_permissions role_permissions[]
  users            users[]
}

model system_config {
  config_id    String   @id @default(uuid()) @db.VarChar(36)
  config_key   String   @unique @db.VarChar(100)
  config_value String
  config_type  String   @db.VarChar(20)
  description  String?
  created_at   DateTime @default(now()) @db.Timestamp(6)
  updated_at   DateTime @default(now()) @db.Timestamp(6)
}

model user_favorites {
  favorite_id String    @id @default(uuid()) @db.VarChar(36)
  user_id     String    @db.VarChar(36)
  resource_id String    @db.VarChar(36)
  created_at  DateTime  @default(now()) @db.Timestamp(6)
  resources   resources @relation(fields: [resource_id], references: [resource_id], onDelete: Cascade)
  users       users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, resource_id])
  @@index([created_at(sort: Desc)])
  @@index([resource_id])
  @@index([user_id])
}

model user_tasks {
  record_id       String       @id @default(uuid()) @db.VarChar(36)
  user_id         String?      @db.VarChar(36)
  task_id         String?      @db.VarChar(36)
  task_code       String       @db.VarChar(50)
  completed_count Int          @default(0)
  target_count    Int
  is_completed    Boolean      @default(false)
  task_date       DateTime     @db.Date
  completed_at    DateTime?    @db.Timestamp(6)
  created_at      DateTime     @default(now()) @db.Timestamp(6)
  updated_at      DateTime     @default(now()) @db.Timestamp(6)
  daily_tasks     daily_tasks? @relation(fields: [task_id], references: [task_id])
  users           users?       @relation(fields: [user_id], references: [user_id])

  @@unique([user_id, task_id, task_date])
  @@index([is_completed])
  @@index([task_date])
  @@index([user_id])
}

model users {
  user_id                                                         String                    @id @default(uuid()) @db.VarChar(36)
  phone                                                           String                    @unique @db.VarChar(20)
  password_hash                                                   String                    @db.VarChar(255)
  nickname                                                        String?                   @db.VarChar(50)
  avatar                                                          String?                   @db.VarChar(500)
  email                                                           String?                   @db.VarChar(100)
  bio                                                             String?
  vip_level                                                       Int                       @default(0)
  vip_expire_at                                                   DateTime?                 @db.Timestamp(6)
  points_balance                                                  Int                       @default(0)
  points_total                                                    Int                       @default(0)
  user_level                                                      Int                       @default(1)
  role_id                                                         String?                   @db.VarChar(36)
  status                                                          Int                       @default(1)
  created_at                                                      DateTime                  @default(now()) @db.Timestamp(6)
  updated_at                                                      DateTime                  @default(now()) @db.Timestamp(6)
  last_login_at                                                   DateTime?                 @db.Timestamp(6)
  // VIP支付系统扩展字段
  is_lifetime_vip                                                 Boolean                   @default(false)
  vip_activated_at                                                DateTime?                 @db.Timestamp(6)
  payment_locked                                                  Boolean                   @default(false)
  payment_locked_at                                               DateTime?                 @db.Timestamp(6)
  payment_lock_reason                                             String?                   @db.VarChar(200)

  admin_operation_logs_admin_operation_logs_operator_idTousers    admin_operation_logs[]    @relation("admin_operation_logs_operator_idTousers")
  admin_operation_logs_admin_operation_logs_target_user_idTousers admin_operation_logs[]    @relation("admin_operation_logs_target_user_idTousers")
  audit_logs                                                      audit_logs[]
  download_history                                                download_history[]
  orders                                                          orders[]
  points_exchange_records                                         points_exchange_records[]
  points_records                                                  points_records[]
  resources_resources_auditor_idTousers                           resources[]               @relation("resources_auditor_idTousers")
  resources_resources_user_idTousers                              resources[]               @relation("resources_user_idTousers")
  user_favorites                                                  user_favorites[]
  user_tasks                                                      user_tasks[]
  roles                                                           roles?                    @relation(fields: [role_id], references: [role_id])
  // VIP支付系统关联
  device_sessions                                                 device_sessions[]
  security_logs                                                   security_logs[]
  refund_requests_user                                            refund_requests[]         @relation("refund_requests_user_idTousers")
  refund_requests_reviewer                                        refund_requests[]         @relation("refund_requests_reviewer_idTousers")
  user_download_stats                                             user_download_stats[]
  notifications                                                   notifications[]
  points_vip_exchanges                                            points_vip_exchanges[]

  @@index([phone])
  @@index([role_id])
  @@index([status])
  @@index([user_level])
  @@index([vip_level])
  @@index([is_lifetime_vip])
}

model vip_packages {
  package_id           String                 @id @default(uuid()) @db.VarChar(36)
  package_name         String                 @db.VarChar(50)
  package_code         String                 @unique @db.VarChar(50)
  duration_days        Int
  original_price       Decimal                @db.Decimal(10, 2)
  current_price        Decimal                @db.Decimal(10, 2)
  description          String?
  sort_order           Int                    @default(0)
  status               Int                    @default(1)
  created_at           DateTime               @default(now()) @db.Timestamp(6)
  updated_at           DateTime               @default(now()) @db.Timestamp(6)
  // VIP支付系统关联
  vip_orders           vip_orders[]
  points_vip_exchanges points_vip_exchanges[]

  @@index([sort_order])
  @@index([status])
}

model vip_privileges {
  privilege_id    String   @id @default(uuid()) @db.VarChar(36)
  privilege_name  String   @db.VarChar(50)
  privilege_code  String   @unique @db.VarChar(50)
  privilege_type  String   @db.VarChar(20)
  privilege_value String
  description     String?
  is_enabled      Boolean  @default(true)
  sort_order      Int      @default(0)
  created_at      DateTime @default(now()) @db.Timestamp(6)
  updated_at      DateTime @default(now()) @db.Timestamp(6)

  @@index([is_enabled])
}

// ==================== VIP支付系统新增表 ====================

// VIP订单扩展表
model vip_orders {
  vip_order_id            String   @id @default(uuid()) @db.VarChar(36)
  order_id                String   @db.VarChar(36)
  package_id              String   @db.VarChar(36)
  source_url              String?  @db.VarChar(500)
  source_resource_id      String?  @db.VarChar(36)
  device_fingerprint      String?  @db.VarChar(100)
  device_info             Json?
  ip_address              String?  @db.VarChar(50)
  require_secondary_auth  Boolean  @default(false)
  secondary_auth_verified Boolean  @default(false)
  created_at              DateTime @default(now()) @db.Timestamp(6)
  updated_at              DateTime @default(now()) @db.Timestamp(6)

  orders       orders       @relation(fields: [order_id], references: [order_id])
  vip_packages vip_packages @relation(fields: [package_id], references: [package_id])

  @@index([order_id])
  @@index([package_id])
}

// 支付回调记录表
model payment_callbacks {
  callback_id     String   @id @default(uuid()) @db.VarChar(36)
  order_no        String   @db.VarChar(50)
  channel         String   @db.VarChar(20)
  transaction_id  String?  @db.VarChar(100)
  callback_data   Json
  signature       String?  @db.VarChar(500)
  signature_valid Boolean?
  processed       Boolean  @default(false)
  process_result  String?  @db.VarChar(50)
  error_message   String?
  created_at      DateTime @default(now()) @db.Timestamp(6)

  @@index([order_no])
  @@index([processed])
  @@index([created_at(sort: Desc)])
}

// 设备会话表
model device_sessions {
  session_id         String    @id @default(uuid()) @db.VarChar(36)
  user_id            String    @db.VarChar(36)
  device_fingerprint String    @db.VarChar(100)
  device_type        String?   @db.VarChar(20)
  browser            String?   @db.VarChar(50)
  os                 String?   @db.VarChar(50)
  ip_address         String?   @db.VarChar(50)
  user_agent         String?
  is_active          Boolean   @default(true)
  last_active_at     DateTime  @default(now()) @db.Timestamp(6)
  kicked_at          DateTime? @db.Timestamp(6)
  kicked_reason      String?   @db.VarChar(100)
  created_at         DateTime  @default(now()) @db.Timestamp(6)

  users users @relation(fields: [user_id], references: [user_id])

  @@index([user_id])
  @@index([device_fingerprint])
  @@index([is_active])
}

// 安全日志表
model security_logs {
  log_id             String   @id @default(uuid()) @db.VarChar(36)
  user_id            String?  @db.VarChar(36)
  event_type         String   @db.VarChar(50)
  event_data         Json?
  ip_address         String?  @db.VarChar(50)
  device_fingerprint String?  @db.VarChar(100)
  risk_level         String?  @db.VarChar(20)
  action_taken       String?  @db.VarChar(50)
  created_at         DateTime @default(now()) @db.Timestamp(6)

  users users? @relation(fields: [user_id], references: [user_id])

  @@index([user_id])
  @@index([event_type])
  @@index([created_at(sort: Desc)])
}

// 退款申请表
model refund_requests {
  refund_id             String    @id @default(uuid()) @db.VarChar(36)
  order_id              String    @db.VarChar(36)
  user_id               String    @db.VarChar(36)
  refund_amount         Decimal   @db.Decimal(10, 2)
  reason                String?   @db.VarChar(200)
  reason_type           String?   @db.VarChar(50)
  status                Int       @default(0)
  reviewer_id           String?   @db.VarChar(36)
  review_note           String?
  reviewed_at           DateTime? @db.Timestamp(6)
  refund_transaction_id String?   @db.VarChar(100)
  refunded_at           DateTime? @db.Timestamp(6)
  created_at            DateTime  @default(now()) @db.Timestamp(6)
  updated_at            DateTime  @default(now()) @db.Timestamp(6)

  orders                              orders @relation(fields: [order_id], references: [order_id])
  users_refund_requests_user_id       users  @relation("refund_requests_user_idTousers", fields: [user_id], references: [user_id])
  users_refund_requests_reviewer_id   users? @relation("refund_requests_reviewer_idTousers", fields: [reviewer_id], references: [user_id])

  @@index([order_id])
  @@index([user_id])
  @@index([status])
}

// 用户下载统计表
model user_download_stats {
  stat_id             String   @id @default(uuid()) @db.VarChar(36)
  user_id             String   @db.VarChar(36)
  stat_date           DateTime @db.Date
  vip_download_count  Int      @default(0)
  free_download_count Int      @default(0)
  created_at          DateTime @default(now()) @db.Timestamp(6)
  updated_at          DateTime @default(now()) @db.Timestamp(6)

  users users @relation(fields: [user_id], references: [user_id])

  @@unique([user_id, stat_date])
  @@index([user_id, stat_date])
}

// 站内信表
model notifications {
  notification_id String    @id @default(uuid()) @db.VarChar(36)
  user_id         String    @db.VarChar(36)
  title           String    @db.VarChar(200)
  content         String
  type            String    @db.VarChar(50)
  link_url        String?   @db.VarChar(500)
  is_read         Boolean   @default(false)
  read_at         DateTime? @db.Timestamp(6)
  created_at      DateTime  @default(now()) @db.Timestamp(6)

  users users @relation(fields: [user_id], references: [user_id])

  @@index([user_id])
  @@index([is_read])
  @@index([created_at(sort: Desc)])
}

// 积分兑换VIP记录表
model points_vip_exchanges {
  exchange_id      String   @id @default(uuid()) @db.VarChar(36)
  user_id          String   @db.VarChar(36)
  package_id       String   @db.VarChar(36)
  points_cost      Int
  exchange_month   DateTime @db.Date
  vip_days_granted Int
  status           Int      @default(1)
  created_at       DateTime @default(now()) @db.Timestamp(6)

  users        users        @relation(fields: [user_id], references: [user_id])
  vip_packages vip_packages @relation(fields: [package_id], references: [package_id])

  @@unique([user_id, exchange_month])
  @@index([user_id])
  @@index([exchange_month])
}
