# VIP支付系统沙箱环境测试指南

## 概述

本文档提供微信支付和支付宝沙箱环境的配置和测试指南。沙箱环境用于在不产生真实交易的情况下测试支付流程。

## 一、微信支付沙箱环境配置

### 1.1 获取沙箱密钥

微信支付沙箱环境使用特殊的沙箱密钥，需要通过API获取：

```bash
# 获取沙箱密钥的API
POST https://api.mch.weixin.qq.com/sandboxnew/pay/getsignkey

# 请求参数
mch_id: 商户号
nonce_str: 随机字符串
sign: 签名（使用正式环境的API密钥签名）
```

### 1.2 沙箱环境配置

在 `backend/.env` 中配置：

```env
# 支付环境设置为沙箱
PAYMENT_ENV=sandbox

# 微信支付沙箱配置
WECHAT_APP_ID=你的AppID
WECHAT_MCH_ID=你的商户号
WECHAT_API_KEY=沙箱密钥（通过API获取）
WECHAT_API_V3_KEY=沙箱V3密钥

# 沙箱回调地址（可使用内网穿透工具）
WECHAT_NOTIFY_URL=https://your-ngrok-url.ngrok.io/api/v1/payment/wechat/notify
```

### 1.3 沙箱测试金额

微信支付沙箱环境有固定的测试金额规则：

| 测试场景 | 金额（分） | 预期结果 |
|---------|-----------|---------|
| 支付成功 | 101 | 支付成功 |
| 支付成功 | 102 | 支付成功 |
| 支付失败 | 201 | 订单不存在 |
| 支付失败 | 202 | 商户订单号重复 |
| 支付失败 | 301 | 金额不足 |

### 1.4 内网穿透配置

推荐使用 ngrok 进行内网穿透：

```bash
# 安装 ngrok
npm install -g ngrok

# 启动内网穿透（假设后端运行在8080端口）
ngrok http 8080

# 获取公网URL，如：https://abc123.ngrok.io
# 将此URL配置到 WECHAT_NOTIFY_URL
```

---

## 二、支付宝沙箱环境配置

### 2.1 创建沙箱应用

1. 登录 [支付宝开放平台](https://open.alipay.com/)
2. 进入「沙箱环境」
3. 获取沙箱应用的 AppID、私钥、支付宝公钥

### 2.2 沙箱环境配置

在 `backend/.env` 中配置：

```env
# 支付环境设置为沙箱
PAYMENT_ENV=sandbox

# 支付宝沙箱配置
ALIPAY_APP_ID=沙箱应用AppID
ALIPAY_PRIVATE_KEY=沙箱应用私钥
ALIPAY_PUBLIC_KEY=沙箱支付宝公钥

# 沙箱网关（重要！）
ALIPAY_GATEWAY=https://openapi.alipaydev.com/gateway.do

# 沙箱回调地址
ALIPAY_NOTIFY_URL=https://your-ngrok-url.ngrok.io/api/v1/payment/alipay/notify
ALIPAY_RETURN_URL=http://localhost:3000/vip/payment/success
```

### 2.3 沙箱测试账号

支付宝沙箱提供测试买家账号：

- 登录沙箱环境获取测试账号
- 账号格式：手机号
- 密码：沙箱环境提供
- 支付密码：111111（默认）

### 2.4 沙箱钱包App

下载「支付宝沙箱版」App进行扫码支付测试：
- Android: 支付宝开放平台下载
- iOS: 支付宝开放平台下载

---

## 三、测试流程

### 3.1 环境准备

```bash
# 1. 启动后端服务
cd backend
npm run dev

# 2. 启动前端服务
cd ..
npm run dev

# 3. 启动内网穿透（新终端）
ngrok http 8080
```

### 3.2 微信支付测试流程

1. **创建订单**
   - 访问 VIP 中心页面
   - 选择套餐，点击购买
   - 选择微信支付

2. **扫码支付**
   - 使用微信扫描二维码
   - 沙箱环境会自动模拟支付

3. **验证回调**
   - 检查后端日志，确认收到回调
   - 检查订单状态是否更新为已支付
   - 检查用户VIP状态是否开通

### 3.3 支付宝测试流程

1. **创建订单**
   - 访问 VIP 中心页面
   - 选择套餐，点击购买
   - 选择支付宝支付

2. **跳转支付**
   - PC端：跳转到支付宝收银台
   - 移动端：跳转到支付宝WAP页面

3. **使用沙箱账号支付**
   - 输入沙箱测试账号
   - 输入支付密码（111111）

4. **验证回调**
   - 检查后端日志，确认收到回调
   - 检查订单状态是否更新
   - 检查用户VIP状态

### 3.4 退款测试流程

1. **申请退款**
   - 进入订单详情页
   - 点击「申请退款」
   - 填写退款原因

2. **管理员审核**
   - 登录管理后台
   - 进入退款管理页面
   - 审核通过退款申请

3. **验证退款**
   - 检查退款状态
   - 检查用户VIP状态是否取消
   - 检查支付渠道退款结果

---

## 四、测试用例清单

### 4.1 支付流程测试

| 测试项 | 预期结果 | 状态 |
|-------|---------|------|
| 微信Native支付（PC扫码） | 生成二维码，支付成功后更新订单 | ⬜ |
| 微信H5支付（移动端） | 跳转微信支付，支付成功后回调 | ⬜ |
| 支付宝PC支付 | 跳转收银台，支付成功后回调 | ⬜ |
| 支付宝WAP支付 | 跳转WAP页面，支付成功后回调 | ⬜ |
| 订单超时取消 | 15分钟未支付自动取消 | ⬜ |
| 重复支付防护 | 同一订单不能重复支付 | ⬜ |

### 4.2 退款流程测试

| 测试项 | 预期结果 | 状态 |
|-------|---------|------|
| 7天内申请退款 | 可以申请退款 | ⬜ |
| 超过7天申请退款 | 不能申请退款 | ⬜ |
| 退款审核通过 | 发起退款，取消VIP | ⬜ |
| 退款审核拒绝 | 保持VIP状态 | ⬜ |
| 部分退款 | 按比例退款 | ⬜ |

### 4.3 积分兑换测试

| 测试项 | 预期结果 | 状态 |
|-------|---------|------|
| 积分充足兑换 | 扣除积分，开通VIP | ⬜ |
| 积分不足兑换 | 提示积分不足 | ⬜ |
| 本月已兑换 | 提示本月已兑换 | ⬜ |
| 兑换1-3个月 | 正确计算到期时间 | ⬜ |

### 4.4 安全测试

| 测试项 | 预期结果 | 状态 |
|-------|---------|------|
| 大额支付二次验证 | ≥200元需要验证码 | ⬜ |
| 频繁创建订单限制 | 每小时最多5个未支付订单 | ⬜ |
| 设备数量限制 | 最多3台设备同时登录 | ⬜ |
| 回调签名验证 | 拒绝无效签名的回调 | ⬜ |

---

## 五、常见问题

### Q1: 微信支付回调收不到？

1. 检查内网穿透是否正常
2. 检查 WECHAT_NOTIFY_URL 配置
3. 检查防火墙设置
4. 查看 ngrok 控制台的请求日志

### Q2: 支付宝沙箱支付失败？

1. 确认使用沙箱网关地址
2. 确认使用沙箱应用的密钥
3. 确认使用沙箱测试账号
4. 检查签名是否正确

### Q3: 订单状态不更新？

1. 检查回调接口是否正常响应
2. 检查数据库连接
3. 查看后端错误日志
4. 手动触发对账任务

### Q4: 如何调试回调？

```bash
# 查看后端日志
tail -f backend/logs/app.log

# 使用 ngrok 控制台
# 访问 http://127.0.0.1:4040 查看请求详情
```

---

## 六、测试报告模板

```markdown
# VIP支付系统沙箱测试报告

## 测试信息
- 测试日期：YYYY-MM-DD
- 测试人员：XXX
- 测试环境：沙箱

## 测试结果汇总
- 总测试用例：XX
- 通过：XX
- 失败：XX
- 跳过：XX

## 详细测试结果

### 微信支付
| 测试项 | 结果 | 备注 |
|-------|------|------|
| Native支付 | ✅/❌ | |
| H5支付 | ✅/❌ | |

### 支付宝支付
| 测试项 | 结果 | 备注 |
|-------|------|------|
| PC支付 | ✅/❌ | |
| WAP支付 | ✅/❌ | |

### 退款流程
| 测试项 | 结果 | 备注 |
|-------|------|------|
| 申请退款 | ✅/❌ | |
| 退款审核 | ✅/❌ | |

## 发现的问题
1. 问题描述...
2. 问题描述...

## 建议
1. 建议内容...
2. 建议内容...
```

---

## 七、切换到生产环境

完成沙箱测试后，切换到生产环境：

1. 修改 `PAYMENT_ENV=production`
2. 配置正式的商户密钥
3. 配置正式的回调地址（HTTPS）
4. 在支付平台配置回调白名单
5. 进行小额真实支付测试
