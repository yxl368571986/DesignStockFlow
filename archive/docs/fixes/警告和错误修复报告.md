# æµè§ˆå™¨è­¦å‘Šå’Œé”™è¯¯ä¿®å¤æŠ¥å‘Š

## ä¿®å¤çš„é—®é¢˜

### 1. âŒ CSPé”™è¯¯: frame-ancestors æŒ‡ä»¤è¢«å¿½ç•¥

**é”™è¯¯ä¿¡æ¯**:
```
The Content Security Policy directive 'frame-ancestors' is ignored when delivered via a <meta> element.
```

**åŸå› **:
- `frame-ancestors` æŒ‡ä»¤åªèƒ½åœ¨HTTPå“åº”å¤´ä¸­è®¾ç½®
- åœ¨HTMLçš„ `<meta>` æ ‡ç­¾ä¸­è®¾ç½®ä¼šè¢«æµè§ˆå™¨å¿½ç•¥

**ä¿®å¤æ–¹æ¡ˆ**:

#### å¼€å‘ç¯å¢ƒ (index.html)
ä»metaæ ‡ç­¾ä¸­ç§»é™¤ `frame-ancestors` æŒ‡ä»¤ï¼š

```html
<!-- ä¿®å¤å‰ -->
<meta http-equiv="Content-Security-Policy" 
      content="... frame-ancestors 'none';">

<!-- ä¿®å¤å -->
<meta http-equiv="Content-Security-Policy" 
      content="... ">
<!-- æ·»åŠ æ³¨é‡Šè¯´æ˜ -->
<!-- æ³¨æ„: frame-ancestors æŒ‡ä»¤åœ¨ meta æ ‡ç­¾ä¸­ä¼šè¢«å¿½ç•¥ï¼Œåº”è¯¥åœ¨ HTTP å“åº”å¤´ä¸­è®¾ç½® -->
```

#### ç”Ÿäº§ç¯å¢ƒ (nginx.conf.example)
åœ¨Nginxé…ç½®ä¸­é€šè¿‡HTTPå“åº”å¤´è®¾ç½®ï¼š

```nginx
# æ­£ç¡®çš„æ–¹å¼ - åœ¨HTTPå“åº”å¤´ä¸­è®¾ç½®
add_header Content-Security-Policy "... frame-ancestors 'none'; ..." always;
```

**éªŒè¯**:
- âœ… æµè§ˆå™¨æ§åˆ¶å°ä¸å†æ˜¾ç¤ºCSPé”™è¯¯
- âœ… ç”Ÿäº§ç¯å¢ƒé€šè¿‡Nginxæ­£ç¡®è®¾ç½®frame-ancestors

---

### 2. âš ï¸ é¢„åŠ è½½è­¦å‘Š: å‡­è¯æ¨¡å¼ä¸åŒ¹é…

**è­¦å‘Šä¿¡æ¯**:
```
A preload for 'http://localhost:3000/src/main.ts' is found, but is not used because the request credentials mode does not match.
```

**åŸå› **:
- ä½¿ç”¨ `<link rel="preload" as="script">` é¢„åŠ è½½ESæ¨¡å—
- ESæ¨¡å—åº”è¯¥ä½¿ç”¨ `<link rel="modulepreload">` è€Œä¸æ˜¯ `rel="preload"`

**ä¿®å¤æ–¹æ¡ˆ**:

```html
<!-- ä¿®å¤å‰ -->
<link rel="preload" href="/src/main.ts" as="script" />

<!-- ä¿®å¤å -->
<link rel="modulepreload" href="/src/main.ts" />
```

**è¯´æ˜**:
- `modulepreload` æ˜¯ä¸“é—¨ä¸ºESæ¨¡å—è®¾è®¡çš„é¢„åŠ è½½æ–¹å¼
- è‡ªåŠ¨å¤„ç†æ¨¡å—çš„ä¾èµ–å…³ç³»
- æ­£ç¡®è®¾ç½®å‡­è¯æ¨¡å¼ï¼ˆcredentials modeï¼‰

**éªŒè¯**:
- âœ… æµè§ˆå™¨æ§åˆ¶å°ä¸å†æ˜¾ç¤ºé¢„åŠ è½½è­¦å‘Š
- âœ… main.ts æ­£ç¡®é¢„åŠ è½½

---

### 3. âš ï¸ Metaæ ‡ç­¾è­¦å‘Š: apple-mobile-web-app-capable å·²å¼ƒç”¨

**è­¦å‘Šä¿¡æ¯**:
```
<meta name="apple-mobile-web-app-capable" content="yes"> is deprecated. Please include <meta name="mobile-web-app-capable" content="yes">
```

**åŸå› **:
- `apple-mobile-web-app-capable` æ˜¯æ—§çš„iOSä¸“ç”¨æ ‡ç­¾
- ç°ä»£æ ‡å‡†æ¨èä½¿ç”¨ `mobile-web-app-capable`

**ä¿®å¤æ–¹æ¡ˆ**:

```html
<!-- ä¿®å¤å‰ -->
<meta name="apple-mobile-web-app-capable" content="yes" />

<!-- ä¿®å¤å -->
<meta name="mobile-web-app-capable" content="yes" />
```

**è¯´æ˜**:
- `mobile-web-app-capable` æ˜¯è·¨å¹³å°æ ‡å‡†
- åŒæ—¶æ”¯æŒiOSå’ŒAndroid
- å‘åå…¼å®¹ï¼Œä¸å½±å“æ—§ç‰ˆiOSè®¾å¤‡

**éªŒè¯**:
- âœ… æµè§ˆå™¨æ§åˆ¶å°ä¸å†æ˜¾ç¤ºå¼ƒç”¨è­¦å‘Š
- âœ… PWAåŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. index.html

**ä¿®æ”¹å†…å®¹**:
1. ç§»é™¤CSP metaæ ‡ç­¾ä¸­çš„ `frame-ancestors` æŒ‡ä»¤
2. æ·»åŠ æ³¨é‡Šè¯´æ˜frame-ancestorsåº”åœ¨HTTPå“åº”å¤´ä¸­è®¾ç½®
3. å°† `<link rel="preload" as="script">` æ”¹ä¸º `<link rel="modulepreload">`
4. å°† `apple-mobile-web-app-capable` æ”¹ä¸º `mobile-web-app-capable`

**ä¿®æ”¹åçš„å…³é”®éƒ¨åˆ†**:

```html
<!-- CSPé…ç½® -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline' 'unsafe-eval'; 
               style-src 'self' 'unsafe-inline'; 
               img-src 'self' data: https: http:; 
               font-src 'self' data: https: http:; 
               connect-src 'self' http://localhost:* https://api.startide-design.com https://cdn.startide-design.com ws://localhost:*;">
<!-- æ³¨æ„: frame-ancestors æŒ‡ä»¤åœ¨ meta æ ‡ç­¾ä¸­ä¼šè¢«å¿½ç•¥ï¼Œåº”è¯¥åœ¨ HTTP å“åº”å¤´ä¸­è®¾ç½® -->

<!-- é¢„åŠ è½½é…ç½® -->
<link rel="preload" href="/src/assets/styles/index.css" as="style" />
<link rel="modulepreload" href="/src/main.ts" />

<!-- PWAé…ç½® -->
<meta name="mobile-web-app-capable" content="yes" />
```

### 2. nginx.conf.example

**å·²åŒ…å«æ­£ç¡®é…ç½®**:

```nginx
# CSPé…ç½®ï¼ˆåŒ…å«frame-ancestorsï¼‰
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://api.startide-design.com wss://api.startide-design.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;" always;
```

---

## éªŒè¯æ­¥éª¤

### 1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

```
1. æŒ‰ Ctrl + Shift + Delete
2. é€‰æ‹©"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
3. ç‚¹å‡»"æ¸…é™¤æ•°æ®"
```

### 2. å¼ºåˆ¶åˆ·æ–°é¡µé¢

```
æŒ‰ Ctrl + F5 æˆ– Cmd + Shift + R
```

### 3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)ï¼ŒæŸ¥çœ‹Consoleæ ‡ç­¾ï¼š

**åº”è¯¥çœ‹åˆ°**:
- âœ… æ²¡æœ‰CSPé”™è¯¯
- âœ… æ²¡æœ‰é¢„åŠ è½½è­¦å‘Š
- âœ… æ²¡æœ‰metaæ ‡ç­¾å¼ƒç”¨è­¦å‘Š
- âœ… "âœ… MockæœåŠ¡å·²å¯ç”¨"
- âœ… "ğŸ­ MockæœåŠ¡å·²å¯åŠ¨"

**ä¸åº”è¯¥çœ‹åˆ°**:
- âŒ frame-ancestors é”™è¯¯
- âŒ preload å‡­è¯æ¨¡å¼è­¦å‘Š
- âŒ apple-mobile-web-app-capable å¼ƒç”¨è­¦å‘Š

### 4. æ£€æŸ¥Networkæ ‡ç­¾

- âœ… main.ts åº”è¯¥æ˜¾ç¤ºä¸ºé¢„åŠ è½½
- âœ… æ‰€æœ‰APIè¯·æ±‚çŠ¶æ€ç ä¸º200
- âœ… æ²¡æœ‰ERR_CONNECTION_REFUSEDé”™è¯¯

---

## æŠ€æœ¯è¯´æ˜

### CSP frame-ancestors æŒ‡ä»¤

**ä¸ºä»€ä¹ˆä¸èƒ½åœ¨metaæ ‡ç­¾ä¸­ä½¿ç”¨?**

æ ¹æ®W3Cè§„èŒƒï¼Œ`frame-ancestors` æŒ‡ä»¤åªèƒ½é€šè¿‡HTTPå“åº”å¤´è®¾ç½®ï¼ŒåŸå› ï¼š

1. **å®‰å…¨æ€§**: metaæ ‡ç­¾å¯ä»¥è¢«é¡µé¢å†…å®¹ä¿®æ”¹ï¼Œä¸å¤Ÿå®‰å…¨
2. **æ—¶åºé—®é¢˜**: æµè§ˆå™¨éœ€è¦åœ¨è§£æHTMLä¹‹å‰å°±çŸ¥é“frame-ancestorsç­–ç•¥
3. **è§„èŒƒè¦æ±‚**: CSP Level 2è§„èŒƒæ˜ç¡®è§„å®šframe-ancestorså¿…é¡»åœ¨HTTPå¤´ä¸­

**æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼**:

```nginx
# Nginxé…ç½®
add_header Content-Security-Policy "frame-ancestors 'none';" always;

# æˆ–è€…å…è®¸ç‰¹å®šåŸŸå
add_header Content-Security-Policy "frame-ancestors 'self' https://trusted-site.com;" always;
```

### modulepreload vs preload

**åŒºåˆ«**:

| ç‰¹æ€§ | preload | modulepreload |
|------|---------|---------------|
| ç”¨é€” | é¢„åŠ è½½æ™®é€šèµ„æº | é¢„åŠ è½½ESæ¨¡å— |
| ä¾èµ–å¤„ç† | ä¸å¤„ç† | è‡ªåŠ¨å¤„ç†æ¨¡å—ä¾èµ– |
| å‡­è¯æ¨¡å¼ | éœ€è¦æ‰‹åŠ¨è®¾ç½® | è‡ªåŠ¨æ­£ç¡®è®¾ç½® |
| æµè§ˆå™¨æ”¯æŒ | å¹¿æ³›æ”¯æŒ | ç°ä»£æµè§ˆå™¨æ”¯æŒ |

**ä½¿ç”¨å»ºè®®**:

```html
<!-- ESæ¨¡å— - ä½¿ç”¨ modulepreload -->
<link rel="modulepreload" href="/src/main.ts" />

<!-- æ™®é€šè„šæœ¬ - ä½¿ç”¨ preload -->
<link rel="preload" href="/vendor.js" as="script" />

<!-- CSS - ä½¿ç”¨ preload -->
<link rel="preload" href="/styles.css" as="style" />

<!-- å­—ä½“ - ä½¿ç”¨ preload -->
<link rel="preload" href="/font.woff2" as="font" type="font/woff2" crossorigin />
```

### PWA Metaæ ‡ç­¾æ¼”è¿›

**å†å²**:
- `apple-mobile-web-app-capable` - iOSä¸“ç”¨ï¼ˆå·²å¼ƒç”¨ï¼‰
- `mobile-web-app-capable` - è·¨å¹³å°æ ‡å‡†ï¼ˆæ¨èï¼‰

**å…¼å®¹æ€§**:

```html
<!-- æ¨èé…ç½® - åŒæ—¶æ”¯æŒæ–°æ—§æ ‡å‡† -->
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="åº”ç”¨åç§°" />
```

---

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. Nginxé…ç½®

ç¡®ä¿åœ¨ç”Ÿäº§ç¯å¢ƒçš„Nginxé…ç½®ä¸­åŒ…å«ï¼š

```nginx
# å®Œæ•´çš„CSPé…ç½®ï¼ˆåŒ…å«frame-ancestorsï¼‰
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' data:;
    connect-src 'self' https://api.startide-design.com;
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
" always;
```

### 2. æµ‹è¯•CSPé…ç½®

ä½¿ç”¨åœ¨çº¿å·¥å…·æµ‹è¯•CSPé…ç½®ï¼š
- [CSP Evaluator](https://csp-evaluator.withgoogle.com/)
- [Security Headers](https://securityheaders.com/)

### 3. ç›‘æ§å’Œæ—¥å¿—

åœ¨Nginxä¸­å¯ç”¨CSPè¿è§„æŠ¥å‘Šï¼š

```nginx
add_header Content-Security-Policy "
    ...
    report-uri /csp-report;
    report-to csp-endpoint;
" always;
```

---

## æ€»ç»“

### ä¿®å¤å‰çš„é—®é¢˜

1. âŒ CSP frame-ancestors é”™è¯¯
2. âš ï¸ modulepreload å‡­è¯æ¨¡å¼è­¦å‘Š
3. âš ï¸ apple-mobile-web-app-capable å¼ƒç”¨è­¦å‘Š

### ä¿®å¤åçš„çŠ¶æ€

1. âœ… æ‰€æœ‰CSPæŒ‡ä»¤æ­£ç¡®é…ç½®
2. âœ… ESæ¨¡å—æ­£ç¡®é¢„åŠ è½½
3. âœ… PWA metaæ ‡ç­¾ä½¿ç”¨ç°ä»£æ ‡å‡†
4. âœ… æµè§ˆå™¨æ§åˆ¶å°æ— è­¦å‘Šå’Œé”™è¯¯
5. âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®å®Œå–„

### å½±å“èŒƒå›´

- **å¼€å‘ç¯å¢ƒ**: ç«‹å³ç”Ÿæ•ˆï¼Œåˆ·æ–°é¡µé¢å³å¯
- **ç”Ÿäº§ç¯å¢ƒ**: éœ€è¦æ›´æ–°Nginxé…ç½®å¹¶é‡è½½
- **ç”¨æˆ·ä½“éªŒ**: æ— å½±å“ï¼Œä»…ä¿®å¤è­¦å‘Š
- **å®‰å…¨æ€§**: æå‡ï¼ˆæ­£ç¡®é…ç½®CSPï¼‰
- **æ€§èƒ½**: æå‡ï¼ˆæ­£ç¡®é¢„åŠ è½½æ¨¡å—ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024-12-21  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ  
**éªŒè¯çŠ¶æ€**: âœ… é€šè¿‡
