# 测试内存优化配置说明

## 问题描述

在运行完整测试套件时遇到JavaScript堆内存溢出错误：
```
FATAL ERROR: invalid table size Allocation failed - JavaScript heap out of memory
```

## 解决方案

### 1. 增加Node.js内存限制

#### 方法1: 使用package.json脚本（推荐）

已在`package.json`中配置：

```json
{
  "scripts": {
    "test": "node --max-old-space-size=4096 ./node_modules/vitest/vitest.mjs --run",
    "test:watch": "node --max-old-space-size=4096 ./node_modules/vitest/vitest.mjs",
    "test:coverage": "node --max-old-space-size=4096 ./node_modules/vitest/vitest.mjs --coverage"
  }
}
```

**说明**: 
- `--max-old-space-size=4096` 将Node.js堆内存限制设置为4GB
- 默认值通常为512MB-1GB，对于大型测试套件不够用

#### 方法2: 使用环境变量

```bash
# Windows PowerShell
$env:NODE_OPTIONS="--max-old-space-size=4096"
npm test

# Linux/Mac
export NODE_OPTIONS="--max-old-space-size=4096"
npm test
```

#### 方法3: 使用安全测试脚本

```bash
# Windows
.\run-tests-safe.ps1

# Linux/Mac
./run-tests-safe.sh
```

### 2. Vitest配置优化

已在`vitest.config.ts`中配置：

```typescript
export default defineConfig({
  test: {
    // 使用单线程模式减少内存占用
    pool: 'threads',
    singleThread: true,
    maxThreads: 1,
    minThreads: 1,
    
    // 限制并发测试数量
    maxConcurrency: 1,
    
    // 隔离测试防止内存泄漏
    isolate: true,
    
    // 禁用文件并行化
    fileParallelism: false,
    
    // 增加超时时间
    testTimeout: 15000,
    hookTimeout: 15000
  }
});
```

**说明**:
- **单线程模式**: 避免多线程带来的额外内存开销
- **限制并发**: 一次只运行一个测试文件
- **测试隔离**: 每个测试在独立环境中运行，防止内存泄漏
- **禁用并行**: 减少同时加载的模块数量

### 3. 分批运行测试

如果内存问题仍然存在，可以分批运行测试：

```bash
# 只运行工具函数测试
npm test -- src/utils/__test__/

# 只运行Composables测试
npm test -- src/composables/__test__/

# 只运行组件测试
npm test -- src/components/**/__test__/

# 只运行Pinia测试
npm test -- src/pinia/__test__/
```

### 4. 运行特定测试文件

```bash
# 运行单个测试文件
npm test -- src/composables/__test__/useDownload.test.ts

# 运行多个测试文件
npm test -- src/composables/__test__/useDownload.test.ts src/composables/__test__/useSearch.test.ts
```

## 测试执行建议

### 开发阶段

1. **使用watch模式**: `npm run test:watch`
   - 只运行修改的测试
   - 自动重新运行
   - 内存占用较低

2. **运行相关测试**: 
   ```bash
   npm test -- src/composables/__test__/useSearch.test.ts --watch
   ```

### CI/CD阶段

1. **使用完整测试**: `npm test`
   - 运行所有测试
   - 使用4GB内存限制
   - 单线程模式

2. **分批运行**（如果需要）:
   ```yaml
   # GitHub Actions示例
   - name: Run Utils Tests
     run: npm test -- src/utils/__test__/
   
   - name: Run Composables Tests
     run: npm test -- src/composables/__test__/
   
   - name: Run Components Tests
     run: npm test -- src/components/**/__test__/
   ```

## 内存使用监控

### 查看当前内存使用

```bash
# Windows
Get-Process node | Select-Object WorkingSet64

# Linux/Mac
ps aux | grep node
```

### 测试运行时监控

```bash
# 使用verbose模式查看详细信息
npm test -- --reporter=verbose
```

## 故障排除

### 问题1: 仍然内存溢出

**解决方案**:
1. 增加内存限制到8GB: `--max-old-space-size=8192`
2. 分批运行测试
3. 检查是否有内存泄漏的测试

### 问题2: 测试运行缓慢

**原因**: 单线程模式会降低测试速度

**解决方案**:
- 开发时使用watch模式只运行相关测试
- CI/CD时接受较慢的速度以换取稳定性

### 问题3: 某些测试超时

**解决方案**:
- 已增加超时时间到15秒
- 如需更长时间，修改`vitest.config.ts`中的`testTimeout`

## 性能对比

### 优化前
- 内存限制: 512MB-1GB（默认）
- 并发: 多线程
- 结果: 内存溢出

### 优化后
- 内存限制: 4GB
- 并发: 单线程
- 结果: 稳定运行

## 相关文档

- [Vitest配置文档](https://vitest.dev/config/)
- [Node.js内存管理](https://nodejs.org/api/cli.html#--max-old-space-sizesize-in-megabytes)
- [测试修复总结](TEST_FIXES_SUMMARY.md)

---

**更新时间**: 2024年12月21日  
**状态**: ✅ 已优化
