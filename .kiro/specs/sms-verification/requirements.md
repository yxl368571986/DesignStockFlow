# 需求文档 - 短信验证功能

## 简介

本功能为注册页面补全短信验证功能，解决以下核心问题：
1. 注册页面输入手机号后，点击"获取验证码"按钮能正常触发短信发送，用户可收到验证码
2. 用户输入验证码后，提交注册时后端能校验该验证码是否与手机号匹配、是否在有效期内、是否正确
3. 整个流程需兼顾安全性（防刷）和用户体验（如倒计时、清晰的提示语）

## 术语表

- **短信服务**: 负责调用第三方短信API（阿里云/腾讯云/Twilio）发送验证码
- **验证码存储服务**: 使用Redis存储验证码，key格式为 `register_sms_{手机号}`
- **认证服务**: 负责用户注册、登录等认证逻辑
- **防刷规则**: 限制验证码请求频率的安全机制
- **Redis**: 分布式内存数据库，用于缓存验证码、防刷计数，支持高并发读写和过期自动清理
- **分布式锁**: 用于解决分布式环境下同一手机号并发请求验证码的竞态问题
- **环境变量**: 用于区分开发/测试/生产环境的配置项，避免硬编码敏感信息
- **错误码**: 前后端统一的异常标识，用于精准定位问题（如 SMS_001 = 发送失败）

## 错误码定义

| 错误码 | 含义 | 提示语 |
|--------|------|--------|
| SMS_001 | 手机号格式错误 | 请输入正确的11位手机号 |
| SMS_002 | 操作频繁（60秒限制） | 获取验证码过于频繁，请60秒后再试 |
| SMS_003 | 单日次数超限 | 今日获取验证码次数已达上限，请明日再试 |
| SMS_004 | 发送失败 | 验证码发送失败，请稍后重试 |
| SMS_005 | 验证码错误 | 验证码错误，请核对后重新输入 |
| SMS_006 | 验证码过期 | 验证码已过期，请重新获取 |
| SMS_007 | 验证码不存在 | 验证码无效或已过期 |
| SMS_008 | IP请求频繁 | 操作过于频繁，请稍后再试 |
| SMS_009 | 系统异常 | 系统异常，请稍后重试 |

## 需求列表

### 需求1: 获取验证码 - 前端逻辑

**用户故事:** 作为用户，我希望点击获取验证码按钮后能收到短信验证码，以便完成注册。

#### 验收标准

1. 当用户点击"获取验证码"按钮时，前端应先校验手机号格式（11位纯数字，以13/14/15/17/18/19开头）
2. 如果手机号格式错误，前端应提示"请输入正确的11位手机号"（错误码SMS_001），不触发后续请求
3. 如果手机号格式正确，前端应立即禁用按钮，按钮文本切换为"60秒后重新获取"，并启动倒计时递减
4. 当后端返回成功时，前端应保持倒计时，提示"验证码已发送至您的手机，请注意查收"
5. 当后端返回失败时，前端应恢复按钮可点击状态，根据错误码显示对应提示
6. 当后端返回"操作频繁"（SMS_002）时，前端应提示"获取验证码过于频繁，请60秒后再试"
7. 倒计时结束后，按钮自动恢复可点击状态，文本恢复为"获取验证码"
8. 前端需校验验证码输入格式（6位纯数字），不符合时提示"请输入6位数字验证码"

### 需求2: 获取验证码 - 后端逻辑

**用户故事:** 作为系统，我需要生成、存储并发送验证码，以便用户完成手机号验证。

#### 验收标准

1. 当后端接收到获取验证码请求时，应先二次校验手机号格式（11位纯数字，以13/14/15/17/18/19开头，与前端规则一致）
2. 当手机号格式校验通过后，后端应检查该手机号最近60秒内是否已请求过验证码
3. 如果60秒内已请求过，后端应返回错误码SMS_002
4. 当防刷校验通过后，后端应通过分布式锁（Redis SETNX）防止同一手机号并发请求
5. 后端应生成6位纯数字随机验证码
6. 当验证码生成后，后端应将验证码存储到Redis，存储格式为JSON：`{"code":"123456","createTime":1699999999999,"used":false}`
7. Redis key为`register_sms_{手机号}`，过期时间5分钟
8. 当验证码存储成功后，后端应调用短信服务发送验证码到用户手机
9. 短信内容模板应为："【星潮设计】您的注册验证码是：{验证码}，5分钟内有效，请勿泄露给他人。"
10. 在开发环境下（SMS_PROVIDER=mock），后端应将验证码打印到控制台而不实际发送短信

### 需求2.1: 短信发送服务集成

**用户故事:** 作为系统，我需要通过短信服务商将验证码发送到用户手机。

#### 验收标准

1. 系统应支持多种短信发送方式，通过环境变量`SMS_PROVIDER`配置
2. 当`SMS_PROVIDER`设置为`mock`或未配置时，系统应使用模拟模式（打印到控制台）
3. 调用第三方短信API失败时，需触发重试（最多2次，间隔1秒，使用指数退避策略）
4. 重试失败后，记录错误日志并返回错误码SMS_004

#### 环境变量配置

```env
# 短信服务商类型（必选）
SMS_PROVIDER=mock  # mock/aliyun/tencent/twilio

# 阿里云短信配置（SMS_PROVIDER=aliyun时生效）
ALIYUN_SMS_ACCESS_KEY_ID=
ALIYUN_SMS_ACCESS_KEY_SECRET=
ALIYUN_SMS_SIGN_NAME=星潮设计
ALIYUN_SMS_TEMPLATE_CODE=

# 腾讯云短信配置（SMS_PROVIDER=tencent时生效）
TENCENT_SMS_SECRET_ID=
TENCENT_SMS_SECRET_KEY=
TENCENT_SMS_SIGN_NAME=星潮设计
TENCENT_SMS_TEMPLATE_ID=

# Twilio短信配置（SMS_PROVIDER=twilio时生效）
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=
TWILIO_PHONE_NUMBER=
```

#### 短信服务商选择

**开发/测试环境（推荐）：**
- 使用`mock`模式，验证码打印到控制台
- 完全免费，无需任何配置

**生产环境：**
- 阿里云短信：约0.045元/条，需提前完成签名和模板审核
- 腾讯云短信：约0.04元/条，需提前完成签名和模板审核
- Twilio：新用户有免费试用额度，支持国际短信

#### 生产环境短信审核要求

使用阿里云/腾讯云等国内服务商时：
1. 需提前完成短信签名审核（如"星潮设计"）
2. 需提前完成短信模板审核，模板需包含验证码占位符
3. 审核通过后才能配置TEMPLATE_CODE/SIGN_NAME
4. 模板审核需符合工信部要求，禁止含敏感词汇

### 需求3: 验证验证码 - 注册提交

**用户故事:** 作为用户，我希望提交注册时系统能验证我的验证码，以证明我拥有该手机号。

#### 验收标准

1. 当用户点击"提交注册"时，前端应先检查验证码输入框是否为空且为6位纯数字
2. 如果验证码为空或格式错误，前端应提示对应错误
3. 当后端接收到注册请求时，应从Redis中查询该手机号对应的验证码记录
4. 如果Redis中不存在该手机号的验证码记录，后端应返回错误码SMS_007
5. 如果验证码存在，后端应对比用户输入的验证码与Redis中存储的验证码是否一致
6. 如果验证码不一致，后端应返回错误码SMS_005
7. 如果验证码生成时间超过5分钟，后端应返回错误码SMS_006
8. 当验证码校验通过后，后端应先将验证码标记为已使用（设置`used:true`），再继续执行注册逻辑
9. 当注册成功后，后端应异步删除Redis中该手机号的验证码记录
10. 若Redis查询失败（如服务宕机），后端返回错误码SMS_009，并记录告警日志

### 需求4: 防刷规则

**用户故事:** 作为系统管理员，我希望限制验证码请求频率，以保护系统免受恶意刷短信攻击。

#### 手机号维度防刷

1. 同一手机号60秒内仅可获取1次验证码
2. 同一手机号单日获取次数不超过5次
3. 如果用户超过60秒限制，后端应返回错误码SMS_002
4. 如果用户超过单日5次限制，后端应返回错误码SMS_003
5. 防刷计数应使用Redis存储，key为`sms_count_{手机号}_{日期}`（日期格式：yyyy-MM-dd），过期时间24小时

#### IP维度防刷

6. 同一IP 60秒内最多发起3次获取验证码请求
7. 同一IP单日最多发起20次获取验证码请求
8. 超过IP限制时，返回错误码SMS_008
9. IP维度防刷计数存储在Redis，key格式为`sms_ip_count_{IP}_{日期}`，过期时间24小时

#### 分布式适配

10. 所有Redis操作需适配分布式环境，确保多实例部署时数据一致性

### 需求5: 验证码格式与有效期

**用户故事:** 作为用户，我希望验证码简单易记且有合理的有效期。

#### 验收标准

1. 验证码应为固定6位纯数字格式（如895674）
2. 验证码有效期应为5分钟
3. 超过5分钟后验证码自动失效，用户需重新获取
4. 所有时间相关字段（如createTime）统一使用Unix时间戳（毫秒级）

### 需求6: 异常场景处理

**用户故事:** 作为用户，我希望在各种异常情况下都能得到清晰的提示。

#### 业务异常

1. 当手机号格式错误时，返回错误码SMS_001
2. 当操作频繁时，返回错误码SMS_002
3. 当验证码过期或不存在时，返回错误码SMS_006或SMS_007
4. 当验证码输入错误时，返回错误码SMS_005
5. 当触发IP防刷规则时，返回错误码SMS_008

#### 系统异常

6. 当Redis服务不可用时，返回错误码SMS_009
7. 当第三方短信服务不可用时，返回错误码SMS_004

#### 日志要求

8. 所有异常场景均需记录详细日志（含手机号脱敏、IP、请求时间、错误码），便于问题排查

## 接口设计

### 获取验证码接口

- **接口地址**: POST `/api/v1/auth/send-code`
- **请求参数**:
```json
{
  "phone": "13800138000",
  "type": "register"
}
```
- **成功响应**:
```json
{
  "code": 200,
  "msg": "验证码发送成功",
  "data": null
}
```
- **失败响应**:
```json
{
  "code": 400,
  "msg": "获取验证码过于频繁，请60秒后再试",
  "errorCode": "SMS_002"
}
```

### 注册接口（含验证码验证）

- **接口地址**: POST `/api/v1/auth/register`
- **请求参数**:
```json
{
  "phone": "13800138000",
  "verify_code": "123456",
  "password": "encrypted_password"
}
```
- **成功响应**:
```json
{
  "code": 200,
  "msg": "注册成功",
  "data": {
    "token": "jwt_token",
    "userInfo": {...},
    "expireTime": 1699999999999
  }
}
```
- **失败响应**:
```json
{
  "code": 400,
  "msg": "验证码错误，请核对后重新输入",
  "errorCode": "SMS_005"
}
```

## 监控告警需求

### 核心监控指标

1. 短信发送成功率（目标≥99.5%）
2. 验证码请求失败率（目标≤1%）
3. 防刷规则触发次数（按手机号/IP维度统计）
4. Redis服务可用性（目标≥99.9%）

### 告警规则

1. 短信发送成功率＜99.5%时，触发告警
2. 防刷触发次数单日＞100次时，触发告警
3. Redis不可用时，触发紧急告警
