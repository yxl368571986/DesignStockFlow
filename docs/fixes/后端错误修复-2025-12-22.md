# 后端错误修复报告

**修复时间**: 2025-12-22  
**修复内容**: Prisma客户端初始化问题和CORS配置问题

## 问题描述

### 问题1: Prisma客户端未定义错误

**错误信息**:
```
Cannot read properties of undefined (reading 'findMany')
at PaymentService.cancelExpiredOrders
```

**原因分析**:
- `paymentService.ts`中的Prisma客户端在模块加载时立即初始化
- 定时任务在应用启动时立即执行，此时Prisma可能还未完全初始化
- 导致`prisma.orders.findMany()`调用失败

### 问题2: CORS跨域错误

**错误信息**:
```
Error: Not allowed by CORS
at origin (E:\KDemo\backend\src\app.ts:42:18)
```

**原因分析**:
- 前端请求的origin不在CORS允许列表中
- 开发环境中可能有多个前端端口（5173, 3000等）
- CORS配置过于严格，阻止了合法的开发请求

## 修复方案

### 修复1: Prisma客户端单例模式

**文件**: `backend/src/services/paymentService.ts`

**修改内容**:

1. **使用单例模式**:
```typescript
// 修改前
const prisma = new PrismaClient();

// 修改后
let prisma: PrismaClient;

function getPrismaClient(): PrismaClient {
  if (!prisma) {
    prisma = new PrismaClient();
  }
  return prisma;
}
```

2. **在每个方法中获取客户端**:
```typescript
async createOrder(data: any) {
  const prisma = getPrismaClient(); // 确保客户端已初始化
  // ... 业务逻辑
}
```

**优点**:
- 延迟初始化，确保在使用时才创建客户端
- 单例模式避免重复创建连接
- 更安全的错误处理

### 修复2: 改进定时任务启动

**文件**: `backend/src/services/paymentScheduler.ts`

**修改内容**:

1. **延迟启动**:
```typescript
// 延迟5秒启动，确保数据库连接已建立
setTimeout(() => {
  checkExpiredOrders(); // 立即执行一次
  setInterval(checkExpiredOrders, interval); // 定期执行
}, 5000);
```

2. **独立的检查函数**:
```typescript
async function checkExpiredOrders() {
  try {
    // ... 检查逻辑
  } catch (error: any) {
    logger.error('取消超时订单失败:', {
      message: error?.message || '未知错误',
      stack: error?.stack
    });
  }
}
```

**优点**:
- 给数据库连接足够的初始化时间
- 更好的错误处理和日志记录
- 代码更清晰易维护

### 修复3: CORS配置优化

**文件**: `backend/src/app.ts`

**修改内容**:

```typescript
cors({
  origin: (origin, callback) => {
    // 开发环境：允许所有来源
    if (config.server.env === 'development') {
      callback(null, true);
      return;
    }
    
    // 生产环境：严格检查
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  // ... 其他配置
})
```

**优点**:
- 开发环境更灵活，允许所有来源
- 生产环境保持严格的安全策略
- 避免开发时的CORS问题

## 测试验证

### 验证步骤

1. **重启后端服务**:
```bash
cd backend
npm run dev
```

2. **检查日志**:
- 应该看到"✅ 支付定时任务已启动"
- 5秒后应该看到"开始检查超时订单..."
- 不应该再有Prisma错误

3. **测试前端请求**:
- 访问前端页面
- 检查个人中心的下载历史
- 不应该再有CORS错误

4. **检查定时任务**:
- 等待10分钟
- 查看日志中是否有定时任务执行记录
- 确认没有错误

### 预期结果

✅ **成功标准**:
1. 后端启动无错误
2. 定时任务正常执行
3. 前端请求无CORS错误
4. Prisma查询正常工作

❌ **如果仍有问题**:
1. 检查数据库连接是否正常
2. 检查`.env`文件配置
3. 查看完整的错误日志

## 相关文件

### 修改的文件
- `backend/src/services/paymentService.ts` - Prisma客户端单例
- `backend/src/services/paymentScheduler.ts` - 定时任务优化
- `backend/src/app.ts` - CORS配置优化

### 配置文件
- `backend/.env` - 环境变量配置
- `backend/src/config/index.ts` - 应用配置

## 最佳实践

### 1. Prisma客户端管理

**推荐做法**:
```typescript
// 创建单独的prisma客户端文件
// backend/src/lib/prisma.ts
import { PrismaClient } from '@prisma/client';

const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma = globalForPrisma.prisma || new PrismaClient();

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma;
}
```

**在服务中使用**:
```typescript
import { prisma } from '@/lib/prisma';

export class PaymentService {
  async createOrder() {
    const order = await prisma.orders.create({...});
  }
}
```

### 2. 定时任务管理

**推荐做法**:
- 使用专业的任务调度库（如`node-cron`）
- 添加任务执行状态监控
- 实现任务失败重试机制
- 记录详细的执行日志

### 3. CORS配置

**推荐做法**:
- 开发环境宽松，生产环境严格
- 使用环境变量配置允许的域名
- 记录被拒绝的请求以便调试
- 定期审查CORS策略

## 后续优化建议

### 1. 数据库连接池

考虑配置Prisma连接池：
```typescript
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
  log: ['query', 'error', 'warn'],
});
```

### 2. 健康检查

添加数据库健康检查端点：
```typescript
app.get('/health/db', async (req, res) => {
  try {
    await prisma.$queryRaw`SELECT 1`;
    res.json({ status: 'ok', database: 'connected' });
  } catch (error) {
    res.status(503).json({ status: 'error', database: 'disconnected' });
  }
});
```

### 3. 优雅关闭

确保应用关闭时断开数据库连接：
```typescript
process.on('SIGTERM', async () => {
  await prisma.$disconnect();
  process.exit(0);
});
```

## 总结

本次修复解决了两个关键问题：

1. **Prisma客户端初始化问题** - 通过单例模式和延迟初始化确保客户端在使用时已准备就绪
2. **CORS跨域问题** - 通过环境区分配置，开发环境更灵活，生产环境保持安全

这些修复提高了应用的稳定性和开发体验，同时保持了生产环境的安全性。

## 注意事项

⚠️ **重要提醒**:
1. 修改后需要重启后端服务
2. 开发环境的宽松CORS配置不应用于生产环境
3. 定期检查日志，确保定时任务正常执行
4. 如果数据库连接有问题，检查PostgreSQL服务是否运行
