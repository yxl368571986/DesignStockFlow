# 设计资源下载网站积分功能开发需求文档（完善版）

## 一、简介

本文档基于原有积分功能开发思路，明确设计资源下载网站积分系统的完整功能需求、业务逻辑、交互规范及技术实现要求。该系统核心目标是为普通用户提供积分获取与消耗渠道，支撑付费资源下载场景，同时赋予管理员全面的积分管理能力，保障积分体系稳定运行。

本需求文档在原有基础上，补充了用户全流程体验细节、异常场景处理、权限控制、数据安全及与现有系统的兼容适配规则，确保覆盖所有实际使用场景。

### 1.1 业务背景

- **VIP用户权益**：可下载平台所有资源（含VIP专属资源、积分兑换资源），积分无限且无需消耗积分下载资源
- **普通用户权益**：需消耗积分下载积分类付费资源，无法下载VIP专属资源
- **积分获取渠道**：普通用户可通过充值获取积分（1元=10积分），管理员可手动调整/赠送用户积分
- **现有系统关联**：需适配后台已有的"积分规则""商城商品""兑换记录""积分统计"模块，确保数据同步与功能联动

### 1.2 核心目标

1. 构建清晰、合理的积分体系，支撑普通用户付费下载场景
2. 提供灵活的积分管理工具，满足管理员运营调控与问题处理需求
3. 保障积分数据准确、交易安全，实现与现有后台系统无缝对接
4. 优化用户体验，让积分充值、兑换、使用流程直观顺畅

## 二、术语表

| 术语 | 定义 |
|------|------|
| 积分系统 | 涵盖积分充值、消耗、管理、统计全流程的核心模块集合 |
| 充值套餐 | 预设的积分充值方案，包含固定价格、基础积分及赠送积分 |
| 充值订单 | 用户发起积分充值时生成的订单记录，含支付状态、金额、积分数量等信息 |
| 积分余额 | 用户当前可直接用于消耗的积分数量 |
| 累计积分 | 用户历史累计获得的积分总额（含已消耗部分，用于用户等级评定等后续扩展场景） |
| 积分变动记录 | 记录用户每笔积分增减的详细日志（含来源、去向、时间、操作人等） |
| 积分商品 | 可通过消耗积分兑换的虚拟/实物商品（如资源兑换券、平台周边等） |
| 兑换记录 | 用户使用积分兑换商品的全流程记录，含订单状态、商品信息、物流信息（实物商品）等 |
| 支付回调 | 第三方支付平台（微信、支付宝）向系统反馈支付结果的接口通知 |
| 积分规则 | 平台定义的积分获取（如签到、上传资源）、消耗（如下载资源）的具体规则 |
| 数据同步 | 积分相关数据（兑换记录、积分统计）在新积分系统与现有后台系统间的实时/定时同步机制 |

## 三、核心业务逻辑梳理

### 3.1 用户身份与积分权限逻辑

```
用户登录 → 验证身份 → 是否为VIP用户？
  ├─ 是 → 积分无限，可下载所有资源（VIP+积分资源），无需消耗积分
  └─ 否 → 普通用户，需通过充值/管理员赠送获取积分
           ├─ 积分充足 → 可下载积分类资源，消耗对应积分
           └─ 积分不足 → 提示充值积分或无法下载
```

### 3.2 积分流转核心逻辑

```
积分生成:
  ├─ 用户充值：1元=10积分，含基础积分+赠送积分
  ├─ 管理员操作：手动赠送/调整积分
  └─ 后续扩展：任务获取（签到、上传资源等）
       ↓
积分存储：用户积分余额/累计积分
       ↓
积分消耗:
  ├─ 下载积分类资源：扣除对应积分
  └─ 兑换积分商城商品：扣除对应积分
       ↓
积分变动记录：实时生成日志，同步至后台
```

## 四、详细需求列表

### 需求1: 积分充值套餐管理

**用户故事:** 
- 作为管理员，需配置合理的充值套餐，覆盖不同用户的积分需求
- 作为普通用户，需清晰了解各套餐性价比，快速选择合适套餐充值

#### 4.1.1 核心需求

- 管理员可创建、编辑、禁用、排序充值套餐
- 套餐需明确展示价格、基础积分、赠送积分、性价比（积分/元），引导用户选择
- 套餐数量精简为3个核心档位，避免用户选择困难

#### 4.1.2 充值套餐配置（优化后3档合理套餐）

| 套餐名称 | 价格 | 基础积分 | 赠送积分 | 总积分 | 赠送比例 | 性价比 | 定位 |
|---------|------|---------|---------|-------|---------|-------|------|
| 体验套餐 | 10元 | 100积分 | 10积分 | 110积分 | 10% | 11积分/元 | 新用户/小额需求 |
| 进阶套餐 | 50元 | 500积分 | 100积分 | 600积分 | 20% | 12积分/元 | 高频普通用户 |
| 尊享套餐 | 100元 | 1000积分 | 250积分 | 1250积分 | 25% | 12.5积分/元 | 大额需求/重度用户 |

#### 验收标准

1. 当管理员创建充值套餐时，系统应验证套餐名称唯一，价格为正数，基础积分与价格匹配（1元=10积分）
2. 当管理员禁用套餐后，前端充值页面应隐藏该套餐，历史充值订单仍保留对该套餐的引用
3. 当管理员调整套餐展示顺序时，前端应按排序结果展示，默认将"进阶套餐"置顶并标注"推荐"标签
4. 系统应明确显示每个套餐的"积分/元"性价比及"节省金额"
5. 系统应支持后续新增/调整套餐档位，新增套餐时不影响现有套餐的正常使用

### 需求2: 用户积分充值

**用户故事:** 作为普通用户，我希望充值流程简单、透明，明确知晓支付状态与积分到账情况；若充值过程中出现异常能快速获知原因并解决。

#### 4.2.1 核心需求

- 支持微信支付、支付宝两种主流支付方式
- 充值流程清晰，包含套餐选择、支付确认、支付结果反馈、积分到账通知
- 处理支付超时、支付失败、重复支付等异常场景
- VIP用户充值提示：明确告知VIP用户无需充值

#### 验收标准

1. 当用户点击"充值积分"后，系统应跳转至充值页面，清晰展示3个套餐及核心信息
2. 当用户选择套餐并点击"立即充值"后，系统应生成唯一充值订单号，展示订单详情
3. 当充值订单生成后，有效期为30分钟，超时未支付应自动取消并通知用户
4. 当收到支付回调时，系统应优先验证签名合法性，验证失败则记录日志并触发告警
5. 当支付成功时，系统应在3秒内完成积分发放，并通过弹窗+站内消息双重通知用户
6. 当充值到账后，系统应自动生成积分变动记录，来源类型标记为"recharge"
7. 当支付失败时，系统应显示失败原因并提供"重新支付"按钮
8. 当支付成功但积分未到账时，系统应自动触发对账校验，10分钟内完成补单
9. 当识别到重复支付时，系统应自动将多余款项原路退回，积分不重复发放
10. 当VIP用户进入充值页面时，系统应显示醒目提示并隐藏充值按钮
11. 系统应支持测试环境（模拟支付）与生产环境（真实支付）切换

### 需求3: 管理员积分调整

**用户故事:** 作为管理员，我需要安全、高效地调整用户积分，用于处理促销活动、用户投诉、数据错误修正等场景，同时所有操作可追溯。

#### 4.3.1 核心需求

- 支持单个用户积分调整（增加/扣除）、批量用户积分赠送
- 操作需验证权限并记录日志，支持追溯
- 扣除积分时需校验余额，避免出现负积分
- 支持输入调整原因，便于后续查询与统计

#### 验收标准

1. 系统应仅允许拥有"积分管理"权限的管理员操作
2. 系统应支持通过用户ID、用户名、手机号精准搜索用户
3. 当管理员调整积分时，系统应要求填写调整原因（必填，20-200字）并二次确认
4. 当批量赠送时，系统应支持Excel导入用户列表或选择"所有用户"
5. 当扣除积分时，系统应自动校验用户当前积分余额，余额不足则阻止操作
6. 当操作成功后，系统应实时更新用户积分余额和累计积分（仅增加/赠送类型）
7. 系统应记录完整的操作日志，包含操作员、时间、目标用户、调整类型、数量、原因
8. 系统应支持管理员发起"撤销操作"（仅限操作后24小时内，且用户未消耗该部分积分）
9. 当单次调整积分≥1000或批量赠送用户数≥100人时，系统应支持配置二次审批
10. 系统应支持配置管理员单次调整积分的上限

### 需求4: 积分规则管理

**用户故事:** 
- 作为管理员，我需要配置并管理积分的获取与消耗规则
- 作为用户，我需要清晰知晓积分的获取方式、消耗标准

#### 4.4.1 核心需求

- 覆盖积分获取（充值、签到、上传资源）与消耗（下载资源）全场景规则
- 规则可配置、可启用/禁用，修改后不影响历史数据
- 前端需向用户清晰展示积分规则

#### 验收标准

1. 系统应支持配置充值规则（1元=10积分，可配置赠送比例）
2. 系统应支持配置签到规则（每日签到积分、连续签到额外奖励），可启用/禁用
3. 系统应支持配置资源上传规则（审核通过后积分奖励，可设置每日上限）
4. 系统应支持配置资源下载规则（不同类型资源的积分消耗标准）
5. 系统应支持配置积分兑换VIP天数规则，可启用/禁用
6. 系统应支持配置积分有效期规则（默认永久有效，支持设置固定有效期）
7. 当积分有效期届满前7天时，系统应通过站内消息提醒用户
8. 系统应支持配置用户积分余额上限（默认无上限）
9. 系统应支持配置用户每日充值次数上限和金额上限
10. 当规则修改/启用/禁用后，系统应仅对后续发生的操作生效
11. 前端"个人中心-积分规则"页面应清晰展示所有启用的积分规则
12. 系统应记录规则的创建、修改、启用/禁用操作日志

### 需求5: 积分商城商品管理

**用户故事:** 
- 作为管理员，我需要管理积分商城的商品
- 作为用户，我需要清晰查看商品信息，快速完成兑换

#### 4.5.1 核心需求

- 支持虚拟商品（VIP天数、资源兑换券）与实物商品（平台周边）管理
- 完善的库存控制机制，支持无限库存配置
- 商品分类展示，信息完整，兑换条件清晰

#### 验收标准

1. 当管理员创建商品时，系统应要求填写商品名称、类型、分类、所需积分、库存、描述、图片
2. 当虚拟商品时，系统应额外要求填写有效期、发放方式（自动/手动）
3. 当实物商品时，系统应额外要求填写规格参数、运费规则、发货地址
4. 当库存设为-1时，系统应判定为无限库存
5. 当库存为0时，前端应显示"已抢完"并阻止兑换
6. 系统应支持管理员手动调整库存，调整记录需留存
7. 系统应支持创建商品分类，前端按分类展示商品
8. 当管理员下架商品时，前端应隐藏该商品，不影响历史兑换记录
9. 当修改商品所需积分时，系统应仅对新的兑换生效
10. 系统应支持配置同一商品的用户兑换次数限制

### 需求6: 积分兑换记录管理

**用户故事:** 
- 作为管理员，我需要跟踪用户的积分兑换记录，处理实物商品发货
- 作为用户，我需要查看自己的兑换历史和物流信息

#### 4.6.1 核心需求

- 完整记录兑换全流程状态，支持状态流转管理
- 实物商品支持物流信息录入与同步
- 明确数据库同步规则，确保与现有系统数据一致

#### 验收标准

1. 当用户兑换虚拟商品时，系统应自动发放商品权益并更新状态为"已完成"
2. 当用户兑换实物商品时，系统应创建兑换记录（状态：待处理），等待管理员审核
3. 当管理员发货实物商品时，系统应更新记录的物流单号，状态改为"已发货"
4. 系统应支持按状态、日期范围、商品类型、用户信息筛选兑换记录
5. 当兑换需要退款时，系统应恢复用户积分并将记录标记为"已退款"
6. 系统应采用实时同步机制，兑换记录创建/状态更新后立即同步至现有后台
7. 当同步失败时，系统应生成同步日志并触发告警，支持手动重试

#### 兑换记录数据库字段

| 字段名 | 字段类型 | 说明 | 是否同步 |
|-------|---------|------|---------|
| exchange_id | varchar(64) | 兑换记录唯一ID | 是 |
| user_id | varchar(64) | 兑换用户ID | 是 |
| goods_id | varchar(64) | 兑换商品ID | 是 |
| goods_name | varchar(255) | 商品名称 | 是 |
| points_needed | int(11) | 兑换所需积分 | 是 |
| exchange_status | tinyint(4) | 兑换状态 | 是 |
| create_time | datetime | 兑换创建时间 | 是 |
| update_time | datetime | 状态更新时间 | 是 |
| logistics_company | varchar(100) | 物流公司 | 是 |
| logistics_no | varchar(64) | 物流单号 | 是 |
| operator_id | varchar(64) | 管理员操作ID | 是 |
| remark | varchar(500) | 备注 | 是 |

### 需求7: 积分统计与报表

**用户故事:** 作为管理员，我需要查看全面的积分统计数据，了解积分体系运行情况，支撑运营决策。

#### 4.7.1 核心需求

- 覆盖积分生成、消耗、留存全维度统计
- 支持多时间维度（日/周/月/年）统计与趋势展示
- 生成可视化报表，数据直观易懂

#### 验收标准

1. 系统应显示积分生成统计：系统总积分、今日/本周/本月新增积分（按来源拆分）
2. 系统应显示积分消耗统计：今日/本周/本月消耗积分（按消耗场景拆分）
3. 系统应显示积分留存统计：用户积分余额分布、积分有效期内未消耗积分总量
4. 系统应显示兑换统计：商品兑换热度排行、虚拟/实物商品兑换占比
5. 系统应显示用户统计：充值用户数、活跃积分用户数、新用户积分获取占比
6. 系统应支持切换日、周、月、年统计维度，支持自定义时间范围查询
7. 系统应提供趋势图、饼图、柱状图等可视化展示
8. 系统应支持导出Excel格式报表
9. 系统应实时同步统计数据至现有后台"积分统计"模块
10. 当统计数据出现异常波动时，系统应自动触发告警

### 需求8: 数据安全与权限控制

**用户故事:** 作为系统管理员，我需要保障积分数据安全，防止积分篡改、泄露；控制不同角色的操作权限。

#### 验收标准

1. 系统应对用户积分余额、充值金额等核心数据采用加密存储
2. 系统应对传输过程采用HTTPS协议
3. 系统应实现权限分级：
   - 超级管理员：拥有所有积分相关操作权限
   - 运营管理员：拥有套餐管理、商品管理、兑换记录处理、基础统计查看权限
   - 普通管理员：仅拥有兑换记录查询、基础统计查看权限
4. 当管理员执行敏感操作时，系统应进行二次验证
5. 系统应记录所有积分相关操作日志，日志保留期限≥1年
6. 系统应确保积分变动记录、订单记录、操作日志一旦生成不可删除/修改
7. 系统应对所有积分相关API接口进行权限校验和频率限制

### 需求9: 系统兼容与异常处理

**用户故事:** 作为开发者，需要确保积分系统与现有网站系统无缝兼容；作为用户/管理员，希望系统在出现异常时能友好提示并快速恢复。

#### 验收标准

1. 系统应复用现有用户ID、用户名等核心信息，不新增独立用户体系
2. 系统应与现有资源管理模块联动，下载资源时自动校验积分余额并扣减
3. 系统应将所有功能模块嵌入现有后台系统，风格与现有页面统一
4. 当用户积分不足下载资源时，系统应提示并提供"立即充值"跳转按钮
5. 当系统故障导致积分未到账时，系统应自动触发对账机制
6. 当兑换商品时库存不足时，系统应提示并建议选择其他商品
7. 当支付渠道异常时，系统应显示提示并提供其他支付方式选项
8. 当用户账号异常（如冻结）时，系统应禁止积分充值、兑换操作
9. 系统应支持数据备份（每日自动备份），故障时可通过备份数据恢复
10. 所有异常提示应语言通俗易懂，同时提供解决方案

## 五、数据库设计

### 5.1 核心表结构

1. **用户积分表（user_points）**：关联现有用户表，存储用户积分余额、累计积分、最后变动时间
2. **充值套餐表（recharge_package）**：新增sort_order（排序字段）、recommend_flag（推荐标记）字段
3. **充值订单表（recharge_order）**：关联现有订单表，order_type标记为"points_recharge"
4. **积分变动记录表（points_change_log）**：关联用户表、订单表、兑换记录表
5. **积分商品表（points_goods）**：关联现有商品表，补充商品分类、库存、物流相关字段
6. **兑换记录表（exchange_record）**：关联用户表、商品表，同步至现有兑换记录表
7. **积分规则表（points_rule）**：关联现有规则配置表，补充规则状态、生效时间字段
8. **操作日志表（operation_log）**：记录所有积分相关操作

### 5.2 表关系说明

- user_points.user_id → user.user_id（一对一）
- recharge_order.user_id → user.user_id（多对一）
- recharge_order.package_id → recharge_package.package_id（多对一）
- points_change_log.user_id → user.user_id（多对一）
- exchange_record.user_id → user.user_id（多对一）
- exchange_record.goods_id → points_goods.goods_id（多对一）

## 六、接口设计规范

### 6.1 接口通用规范

- 遵循现有系统RESTful API规范
- 请求方法：GET（查询）、POST（创建）、PUT（修改）、DELETE（删除/禁用）
- 参数命名：URL参数、请求体参数使用snake_case，响应参数使用camelCase
- 响应格式统一：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "pageInfo": {
    "total": 100,
    "pageNum": 1,
    "pageSize": 10,
    "pages": 10
  }
}
```

### 6.2 核心接口列表

**用户积分相关：**
- GET /api/user/points：查询用户积分余额及累计积分
- GET /api/user/points/log：查询用户积分变动记录（分页）

**充值相关：**
- GET /api/recharge/package：查询可用充值套餐列表
- POST /api/recharge/order：创建充值订单
- GET /api/recharge/order/{orderId}：查询充值订单状态
- POST /api/recharge/callback：支付回调接口

**管理员积分调整相关：**
- POST /api/admin/points/adjust：单个用户积分调整
- POST /api/admin/points/batchGift：批量用户积分赠送
- GET /api/admin/points/adjust/log：查询积分调整操作日志

**兑换相关：**
- POST /api/exchange/create：创建兑换订单
- GET /api/exchange/record：查询兑换记录
- PUT /api/admin/exchange/status：管理员更新兑换记录状态
- POST /api/admin/exchange/refund：兑换退款

**统计相关：**
- GET /api/stat/points/overview：获取积分统计概览数据
- GET /api/stat/points/trend：获取积分生成/消耗趋势数据
- GET /api/stat/exchange/rank：获取商品兑换热度排行

## 七、开发策略与优先级

### 7.1 支付集成策略

需先完成现有系统支付能力核查，分两种场景处理：

**场景一：现有系统已集成微信支付、支付宝**
- 直接复用现有支付通道
- 仅开发积分充值与现有支付模块的联动接口（含订单创建、支付回调对接、积分发放触发逻辑）
- 无需重复开发支付核心功能

**场景二：现有系统未集成微信支付、支付宝**
- 需从零开始完成全流程对接开发
- 包括：商户信息配置、支付网关对接、支付安全校验（签名验证、防篡改）、支付结果回调处理、退款接口对接等

### 7.2 分阶段开发计划

| 阶段 | 功能模块 | 价值说明 |
|-----|---------|---------|
| 第一阶段（核心必做） | 充值套餐 + 用户充值 + 管理员积分调整 | 保障"积分获取"核心链路通畅，满足用户付费下载、管理员应急调整的基础需求，快速实现业务闭环 |
| 第二阶段（次要迭代） | 积分商城 + 兑换记录 | 补充"积分消耗"场景，丰富积分用途，提升用户粘性 |
| 第三阶段（运营优化） | 统计报表 + 高级规则配置 | 基于业务数据支撑运营决策，通过高级规则优化积分体系管控 |

### 7.3 前端入口布局

采用"多入口覆盖"策略，适配不同用户场景：

1. **核心入口：个人中心页面**
   - 在"个人中心"增设"积分管理"模块
   - 内含"积分充值"按钮，作为用户主动充值的常规入口
   - 同时展示积分余额、充值记录等信息，形成积分相关功能聚合

2. **精准入口：资源下载时积分不足的弹窗**
   - 弹窗内直接嵌入"立即充值"按钮
   - 点击跳转至充值页面
   - 精准触达有紧急充值需求的用户，降低转化流失

3. **辅助入口：顶部导航栏（可选）**
   - 若网站顶部导航栏有冗余空间，可增设"积分充值"快捷入口
   - 若导航栏空间紧张，可省略此入口

### 7.4 历史数据迁移策略

需先核查现有用户是否存在历史积分数据：

**若存在历史积分数据：必须迁移**
- 迁移可保障用户体验一致性，避免用户历史积分失效引发投诉
- 迁移步骤：
  1. 对历史数据进行校验（去重、修正异常数据）
  2. 备份原始数据
  3. 通过脚本将用户ID、历史积分余额、积分获取时间等核心字段同步至新积分系统
  4. 生成对应的积分变动记录（来源标记为"历史迁移"）

**若不存在历史积分数据：无需迁移**
- 新积分系统直接从零开始记录积分数据即可

## 八、上线前验证要点

1. **功能验证**：所有核心功能按验收标准逐一测试，覆盖正常/异常场景
2. **数据同步验证**：确认积分数据、兑换记录、统计数据与现有系统同步正常
3. **兼容性验证**：与现有用户体系、资源管理、后台模块兼容，无功能冲突
4. **性能验证**：模拟高并发场景（如1000用户同时充值），系统响应时间≤3秒
5. **安全验证**：测试权限控制、数据加密、接口安全
6. **用户体验验证**：前端流程顺畅，错误提示清晰
7. **后台页面适配验证**：基于现有后台积分管理页面扩展开发，保留原有页面风格
