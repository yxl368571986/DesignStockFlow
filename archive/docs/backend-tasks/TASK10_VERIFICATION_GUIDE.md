# Task 10: ç”¨æˆ·ç®¡ç†API - éªŒè¯æŒ‡å—

## ğŸ¯ éªŒè¯ç›®æ ‡

éªŒè¯ç”¨æˆ·ç®¡ç†APIçš„ä¸‰ä¸ªæ¥å£æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

---

## ğŸ“‹ å‰ç½®æ¡ä»¶

åœ¨å¼€å§‹éªŒè¯ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š

1. âœ… PostgreSQLæ•°æ®åº“å·²å¯åŠ¨
2. âœ… æ•°æ®åº“å·²åˆå§‹åŒ–ï¼ˆæ‰§è¡Œè¿‡ `npm run prisma:migrate` å’Œ `npm run prisma:seed`ï¼‰
3. âœ… åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆ`npm run dev`ï¼‰
4. âœ… æµ‹è¯•è´¦å·å·²åˆ›å»ºï¼ˆseedè„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰

---

## ğŸš€ å¿«é€ŸéªŒè¯

### æ–¹æ³•1: ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd backend
npx tsx src/test-user-api.ts
```

**é¢„æœŸè¾“å‡º**:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ç”¨æˆ·ç®¡ç†APIæµ‹è¯•                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

========================================
æµ‹è¯•1: ç”¨æˆ·ç™»å½•è·å–Token
========================================
âœ… é€šè¿‡ - ç”¨æˆ·ç™»å½•
   ç™»å½•æˆåŠŸï¼Œè·å–åˆ°Token

========================================
æµ‹è¯•2: è·å–ç”¨æˆ·ä¿¡æ¯ (GET /api/v1/user/info)
========================================
âœ… é€šè¿‡ - è·å–ç”¨æˆ·ä¿¡æ¯
   æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯

... (æ›´å¤šæµ‹è¯•)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           æµ‹è¯•æ€»ç»“                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ€»æµ‹è¯•æ•°: 8
âœ… é€šè¿‡: 8
âŒ å¤±è´¥: 0
æˆåŠŸç‡: 100.00%

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

---

### æ–¹æ³•2: ä½¿ç”¨Postman/Insomnia

#### æ­¥éª¤1: ç™»å½•è·å–Token

**è¯·æ±‚**:
```
POST http://localhost:3000/api/v1/auth/login
Content-Type: application/json

{
  "phone": "13800000001",
  "password": "test123456"
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": { ... }
  }
}
```

**ä¿å­˜Token**: å¤åˆ¶å“åº”ä¸­çš„ `token` å€¼ï¼Œåç»­è¯·æ±‚éœ€è¦ä½¿ç”¨ã€‚

---

#### æ­¥éª¤2: è·å–ç”¨æˆ·ä¿¡æ¯

**è¯·æ±‚**:
```
GET http://localhost:3000/api/v1/user/info
Authorization: Bearer <your_token_here>
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 200,
  "message": "è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ",
  "data": {
    "userId": "...",
    "phone": "13800000001",
    "nickname": "æµ‹è¯•ç”¨æˆ·",
    "avatar": null,
    "email": null,
    "bio": null,
    "vipLevel": 0,
    "vipExpireAt": null,
    "roleCode": "user",
    "pointsBalance": 100,
    "pointsTotal": 100,
    "userLevel": 1,
    "status": 1,
    "createdAt": "...",
    "lastLoginAt": "..."
  }
}
```

**éªŒè¯ç‚¹**:
- âœ… è¿”å›çŠ¶æ€ç  200
- âœ… è¿”å›ç”¨æˆ·å®Œæ•´ä¿¡æ¯
- âœ… åŒ…å«VIPä¿¡æ¯å’Œç§¯åˆ†ä¿¡æ¯

---

#### æ­¥éª¤3: æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**è¯·æ±‚**:
```
PUT http://localhost:3000/api/v1/user/info
Authorization: Bearer <your_token_here>
Content-Type: application/json

{
  "nickname": "æ–°æ˜µç§°",
  "bio": "è¿™æ˜¯æˆ‘çš„ä¸ªäººç®€ä»‹",
  "email": "test@example.com"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 200,
  "message": "æ›´æ–°ç”¨æˆ·ä¿¡æ¯æˆåŠŸ",
  "data": {
    "userId": "...",
    "nickname": "æ–°æ˜µç§°",
    "bio": "è¿™æ˜¯æˆ‘çš„ä¸ªäººç®€ä»‹",
    "email": "test@example.com",
    ...
  }
}
```

**éªŒè¯ç‚¹**:
- âœ… è¿”å›çŠ¶æ€ç  200
- âœ… æ˜µç§°å·²æ›´æ–°
- âœ… ä¸ªäººç®€ä»‹å·²æ›´æ–°
- âœ… é‚®ç®±å·²æ›´æ–°

---

#### æ­¥éª¤4: æµ‹è¯•è¾“å…¥éªŒè¯

**æµ‹è¯•æ˜µç§°é•¿åº¦éªŒè¯**:
```
PUT http://localhost:3000/api/v1/user/info
Authorization: Bearer <your_token_here>
Content-Type: application/json

{
  "nickname": "A"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 400,
  "message": "æ˜µç§°é•¿åº¦åº”åœ¨2-50ä¸ªå­—ç¬¦ä¹‹é—´"
}
```

**éªŒè¯ç‚¹**:
- âœ… è¿”å›çŠ¶æ€ç  400
- âœ… è¿”å›æ­£ç¡®çš„é”™è¯¯ä¿¡æ¯

---

#### æ­¥éª¤5: ä¿®æ”¹å¯†ç 

**è¯·æ±‚**:
```
PUT http://localhost:3000/api/v1/user/password
Authorization: Bearer <your_token_here>
Content-Type: application/json

{
  "oldPassword": "test123456",
  "newPassword": "newpassword123"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 200,
  "message": "å¯†ç ä¿®æ”¹æˆåŠŸ",
  "data": null
}
```

**éªŒè¯ç‚¹**:
- âœ… è¿”å›çŠ¶æ€ç  200
- âœ… å¯†ç ä¿®æ”¹æˆåŠŸ

**é‡è¦**: ä¿®æ”¹å¯†ç åï¼Œéœ€è¦ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•ï¼

---

#### æ­¥éª¤6: æµ‹è¯•æ—§å¯†ç éªŒè¯

**è¯·æ±‚**:
```
PUT http://localhost:3000/api/v1/user/password
Authorization: Bearer <your_token_here>
Content-Type: application/json

{
  "oldPassword": "wrongpassword",
  "newPassword": "newpassword123"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 400,
  "message": "æ—§å¯†ç ä¸æ­£ç¡®"
}
```

**éªŒè¯ç‚¹**:
- âœ… è¿”å›çŠ¶æ€ç  400
- âœ… è¿”å›æ­£ç¡®çš„é”™è¯¯ä¿¡æ¯

---

#### æ­¥éª¤7: æµ‹è¯•æœªè®¤è¯è®¿é—®

**è¯·æ±‚**:
```
GET http://localhost:3000/api/v1/user/info
(ä¸å¸¦ Authorization header)
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 401,
  "message": "æœªæä¾›è®¤è¯Token"
}
```

**éªŒè¯ç‚¹**:
- âœ… è¿”å›çŠ¶æ€ç  401
- âœ… è¿”å›æœªè®¤è¯é”™è¯¯

---

### æ–¹æ³•3: ä½¿ç”¨curlå‘½ä»¤

#### 1. ç™»å½•è·å–Token

```bash
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800000001","password":"test123456"}'
```

#### 2. è·å–ç”¨æˆ·ä¿¡æ¯

```bash
TOKEN="your_token_here"

curl -X GET http://localhost:3000/api/v1/user/info \
  -H "Authorization: Bearer $TOKEN"
```

#### 3. æ›´æ–°ç”¨æˆ·ä¿¡æ¯

```bash
curl -X PUT http://localhost:3000/api/v1/user/info \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"nickname":"æ–°æ˜µç§°","bio":"ä¸ªäººç®€ä»‹"}'
```

#### 4. ä¿®æ”¹å¯†ç 

```bash
curl -X PUT http://localhost:3000/api/v1/user/password \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"oldPassword":"test123456","newPassword":"newpass123"}'
```

---

## âœ… éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯

- [ ] è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] ä¿®æ”¹å¯†ç æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] JWTè®¤è¯æ­£å¸¸å·¥ä½œ
- [ ] æœªè®¤è¯è®¿é—®è¿”å›401é”™è¯¯

### è¾“å…¥éªŒè¯

- [ ] æ˜µç§°é•¿åº¦éªŒè¯ï¼ˆ2-50å­—ç¬¦ï¼‰
- [ ] é‚®ç®±æ ¼å¼éªŒè¯
- [ ] ä¸ªäººç®€ä»‹é•¿åº¦éªŒè¯ï¼ˆæœ€å¤š500å­—ç¬¦ï¼‰
- [ ] æ—§å¯†ç éªŒè¯
- [ ] æ–°å¯†ç é•¿åº¦éªŒè¯ï¼ˆè‡³å°‘6ä½ï¼‰

### å®‰å…¨éªŒè¯

- [ ] å¯†ç ä½¿ç”¨bcryptåŠ å¯†å­˜å‚¨
- [ ] JWT Tokenæ­£ç¡®éªŒè¯
- [ ] ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
- [ ] é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿæ•°æ®

### æ•°æ®éªŒè¯

- [ ] ç”¨æˆ·ä¿¡æ¯æ­£ç¡®è¿”å›
- [ ] æ›´æ–°åæ•°æ®æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
- [ ] å¯†ç ä¿®æ”¹åå¯ä»¥ä½¿ç”¨æ–°å¯†ç ç™»å½•
- [ ] VIPä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
- [ ] ç§¯åˆ†ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯**: `Can't reach database server at localhost:5432`

**è§£å†³**:
1. ç¡®è®¤PostgreSQLæœåŠ¡å·²å¯åŠ¨
2. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `DATABASE_URL`
3. ç¡®è®¤æ•°æ®åº“ `startide_design` å·²åˆ›å»º

### é—®é¢˜2: æµ‹è¯•è´¦å·ä¸å­˜åœ¨

**é”™è¯¯**: `æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯`

**è§£å†³**:
```bash
cd backend
npm run prisma:seed
```

### é—®é¢˜3: Tokenæ— æ•ˆ

**é”™è¯¯**: `Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ`

**è§£å†³**:
1. é‡æ–°ç™»å½•è·å–æ–°Token
2. æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®å¤åˆ¶ï¼ˆåŒ…å«å®Œæ•´çš„JWTå­—ç¬¦ä¸²ï¼‰
3. ç¡®è®¤Authorization headeræ ¼å¼: `Bearer <token>`

### é—®é¢˜4: å­—æ®µåä¸åŒ¹é…

**é”™è¯¯**: è¯·æ±‚æˆ–å“åº”å­—æ®µåé”™è¯¯

**è¯´æ˜**: 
- APIä½¿ç”¨ camelCase (å¦‚ `oldPassword`)
- æ•°æ®åº“ä½¿ç”¨ snake_case (å¦‚ `old_password`)
- ä¸­é—´ä»¶ä¼šè‡ªåŠ¨è½¬æ¢ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### å“åº”æ—¶é—´

æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¥å£å“åº”æ—¶é—´åº”è¯¥åœ¨ï¼š
- è·å–ç”¨æˆ·ä¿¡æ¯: < 100ms
- æ›´æ–°ç”¨æˆ·ä¿¡æ¯: < 200ms
- ä¿®æ”¹å¯†ç : < 300ms (åŒ…å«bcryptåŠ å¯†æ—¶é—´)

### å¹¶å‘æµ‹è¯•

å¯ä»¥ä½¿ç”¨ Apache Bench è¿›è¡Œç®€å•çš„å¹¶å‘æµ‹è¯•ï¼š

```bash
# å®‰è£… Apache Bench
# Windows: ä¸‹è½½ Apache HTTP Server
# macOS: brew install httpd
# Linux: sudo apt-get install apache2-utils

# æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼ˆ100ä¸ªè¯·æ±‚ï¼Œ10ä¸ªå¹¶å‘ï¼‰
ab -n 100 -c 10 -H "Authorization: Bearer <token>" \
  http://localhost:3000/api/v1/user/info
```

---

## ğŸ‰ éªŒè¯å®Œæˆ

å¦‚æœæ‰€æœ‰éªŒè¯ç‚¹éƒ½é€šè¿‡ï¼Œè¯´æ˜Task 10å·²æˆåŠŸå®Œæˆï¼

**ä¸‹ä¸€æ­¥**:
- ç»§ç»­å®ç°Task 11: èµ„æºç®¡ç†API
- æˆ–å¼€å§‹å‰ç«¯å¯¹æ¥ï¼Œå®ç°ä¸ªäººä¸­å¿ƒé¡µé¢

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [TASK10_COMPLETION_SUMMARY.md](./TASK10_COMPLETION_SUMMARY.md) - å®Œæˆæ€»ç»“
- [APIæ–‡æ¡£](./API.md) - å®Œæ•´çš„APIæ–‡æ¡£ï¼ˆå¾…åˆ›å»ºï¼‰
- [QUICK_START.md](./QUICK_START.md) - å¿«é€Ÿå¯åŠ¨æŒ‡å—

---

ç¥éªŒè¯é¡ºåˆ©ï¼ğŸš€
