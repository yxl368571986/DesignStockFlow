# 需求文档

## 简介

设计资源上传审核功能，实现完整的文件上传、系统自动审核、人工审核流程。支持生产环境（完整审核）和开发环境（自动通过）两种模式，通过 `audit_status` 字段控制资源在首页/分类页的展示。支持超大文件分片上传、批量操作、重复检测等高级功能。

## 术语表

- **上传系统 (Upload_System)**: 文件上传系统，负责接收用户上传的设计资源文件
- **自动审核服务 (Auto_Audit_Service)**: 系统自动审核服务，负责格式校验、内容校验、压缩包解压检测
- **人工审核系统 (Manual_Audit_System)**: 人工审核后台系统，供管理员审核待审资源
- **资源展示系统 (Resource_Display_System)**: 资源展示系统，负责首页/分类页/个人中心的资源展示
- **通知系统 (Notification_System)**: 站内通知系统，负责向用户推送审核结果
- **审核状态 (audit_status)**: 审核状态字段（0=待审核，1=审核通过，2=审核驳回）
- **审核模式 (AUDIT_MODE)**: 环境配置项（production=生产环境，development=开发环境）
- **设计文件 (Design_File)**: 设计文件，包括 PSD/AI/CDR/JPG/PNG 等格式
- **压缩包文件 (Archive_File)**: 压缩包文件，包括 ZIP/RAR/7Z/TAR/GZIP 等格式
- **文件哈希 (File_Hash)**: 文件的 MD5 哈希值，用于重复检测

## 需求列表

### 需求 1: 环境配置控制

**用户故事:** 作为系统管理员，我希望通过配置项控制审核模式，以便在不同环境使用不同的审核策略。

#### 验收标准

1. 上传系统应支持 AUDIT_MODE 配置项，取值为 "production" 或 "development"
2. 当 AUDIT_MODE 设置为 "production" 时，上传系统应执行完整审核流程（自动审核 → 人工审核）
3. 当 AUDIT_MODE 设置为 "development" 时，上传系统应自动将 audit_status 设置为 1（审核通过）
4. 上传系统应从环境配置文件读取 AUDIT_MODE
5. 如果 AUDIT_MODE 未配置，上传系统应默认使用 "production" 模式
6. AUDIT_MODE 默认全局生效，管理员可在后台临时为指定接口/用户开启"开发模式"（仅测试用），不影响全局配置

### 需求 2: 保留现有验证逻辑

**用户故事:** 作为开发者，我希望保留现有的前端和后端验证逻辑，以便文件安全性验证不受影响。

#### 验收标准

1. 上传系统应保留前端文件名安全性验证（validateFileNameSecurity）
2. 上传系统应保留前端文件内容验证（扩展名 + MIME类型 + 大小，通过 validateFile 实现）
3. 上传系统应保留后端 multer MIME 类型过滤
4. 上传系统应保留后端 multer 文件大小限制，超大文件将自动触发分片上传逻辑突破该限制
5. 当文件未通过任何验证时，上传系统应拒绝上传并返回相应的错误信息

### 需求 3: 分片上传与断点续传

**用户故事:** 作为用户，我希望能上传超大文件，以便不受文件大小限制。

#### 验收标准

1. 上传系统应支持分片上传，适配超大文件（突破 multer 的 fileSize 限制）
2. 分片上传应支持断点续传，中断后可从断点继续上传
3. 当上传中断时，前端应显示"上传中断，点击继续"
4. 当断点续传成功后，前端应提示"已继续上传，进度 xx%"
5. 上传系统应在服务端记录已上传的分片信息，支持断点恢复

### 需求 4: 重复上传检测

**用户故事:** 作为系统管理员，我希望检测重复上传的文件，以便节省存储资源。

#### 验收标准

1. 上传系统应通过文件 MD5 值检测重复上传
2. 若文件已存在且 audit_status=1，上传系统应提示"文件已存在，无需重复上传"
3. 若文件已存在但 audit_status=0 或 2，上传系统应允许重新上传并覆盖原记录

### 需求 5: 批量上传

**用户故事:** 作为用户，我希望能批量上传多个文件，以便提高上传效率。

#### 验收标准

1. 上传系统应支持多文件批量上传
2. 批量上传时，前端应对每个文件执行基础验证（文件名安全性、格式、大小）
3. 批量上传时，前端应显示每个文件的上传进度和状态
4. 当部分文件验证失败时，上传系统应继续上传其他有效文件，并汇总显示失败原因

### 需求 6: 系统自动审核（生产环境）

**用户故事:** 作为用户，我希望上传的文件能被系统自动审核，以便符合规范的文件可以快速通过审核。

#### 验收标准

1. 当文件在生产模式下上传时，自动审核服务应验证文件格式是否在允许列表中（PSD/AI/CDR/JPG/PNG/ZIP/RAR/7Z/TAR/GZIP）
2. 当上传的文件是设计文件时，自动审核服务应验证文件有效性：
   - PSD/AI/CDR 校验文件头格式是否合法
   - JPG/PNG 校验是否包含有效像素信息（非空/非损坏）
3. 当上传的文件是压缩包时，自动审核服务应将其解压到临时目录
4. 当解压压缩包时，自动审核服务应验证至少存在一个有效的设计文件
5. 当解压压缩包时，自动审核服务应检查是否存在非法可执行文件（exe/bat/sh/cmd）
6. 若压缩包解压后无有效设计文件或仅含非法可执行文件，自动审核服务应将 audit_status 设为 0 并转入人工审核，前端提示"压缩包内无有效设计文件，已转入人工审核"
7. 如果压缩包损坏或有密码保护，自动审核服务应将 audit_status 设置为 0，前端弹窗提示"压缩包无法自动解压（损坏/密码保护），已转入人工审核"
8. 当自动审核通过时，自动审核服务应将 audit_status 设置为 1，资源立即展示
9. 当自动审核未通过时，自动审核服务应将 audit_status 设置为 0，转入人工审核
10. 自动审核服务应在审核完成后删除临时解压文件
11. 系统应设置临时文件过期时间（24小时），超时未处理的临时文件自动清理
12. 系统异常崩溃后，重启时应触发临时文件清理

### 需求 7: 人工审核后台

**用户故事:** 作为审核管理员，我希望在后台查看和审核待审资源，以便人工判断资源是否符合规范。

#### 验收标准

1. 人工审核系统应展示 audit_status = 0 的资源列表
2. 待审核列表默认按"上传时间倒序"排列，支持按"上传用户/文件类型"二次筛选
3. 当展示资源时，人工审核系统应显示：上传用户信息、上传时间、文件信息（名称/大小/类型）、audit_status
4. 当资源是压缩包时，人工审核系统应展示解压后的文件列表（名称/格式/大小）
5. 人工审核系统应为图片文件（JPG/PNG）生成 200x200px 缩略图
6. 若图片文件损坏/无法解析，人工审核系统应显示"格式错误"默认图标
7. 人工审核系统应为设计文件（PSD/AI/CDR）显示格式图标
8. 人工审核系统应提供"审核通过"按钮，将 audit_status 设置为 1
9. 人工审核系统应提供"驳回"按钮，将 audit_status 设置为 2，并要求选择/输入驳回原因
10. 驳回时应提供预设下拉选项（"无有效设计文件"/"文件损坏"/"含违规内容"/"压缩包密码保护"），支持自定义补充输入，下拉选项为必填项
11. 人工审核系统应提供"下载原文件"和"预览详情"按钮
12. 图片类文件预览应支持弹窗放大（原图比例）
13. PSD/AI/CDR 文件预览应显示关键信息（格式/尺寸/分辨率）+ 格式图标
14. 当资源审核通过时，资源展示系统应立即在首页和分类页展示该资源
15. 当资源被驳回时，人工审核系统应存储驳回原因，该原因同步展示至用户个人中心对应资源的驳回标签处
16. 人工审核系统的文件列表中，可直接点击缩略图/文件名称，快速预览该文件的详情，无需点击"预览详情"按钮

### 需求 8: 批量审核

**用户故事:** 作为审核管理员，我希望能批量审核多个资源，以便提高审核效率。

#### 验收标准

1. 人工审核系统应支持勾选多个待审核资源
2. 人工审核系统应提供批量"审核通过"按钮，将选中资源的 audit_status 批量设置为 1
3. 人工审核系统应提供批量"驳回"按钮，将选中资源的 audit_status 批量设置为 2，并要求输入统一驳回原因
4. 批量操作完成后，人工审核系统应显示操作结果汇总（成功数/失败数）

### 需求 9: 用户端展示规则

**用户故事:** 作为用户，我希望在首页和分类页看到已审核通过的资源，以便浏览和下载高质量内容。

#### 验收标准

1. 资源展示系统应仅在首页展示 audit_status = 1 的资源
2. 资源展示系统应仅在分类页展示 audit_status = 1 的资源
3. 资源展示系统不应在公开页面展示 audit_status = 0 或 2 的资源

### 需求 10: 个人中心资源状态展示

**用户故事:** 作为用户，我希望在个人中心查看我上传资源的审核状态，以便了解审核进度和结果。

#### 验收标准

1. 当 audit_status = 0 时，资源展示系统应在个人中心显示橙色"审核中"标签
2. 当 audit_status = 0 时，资源展示系统应禁用下载和分享功能
3. 当 audit_status = 1 时，资源展示系统应不显示标签，并启用所有功能
4. 当 audit_status = 2 时，资源展示系统应显示灰色"已驳回"标签
5. 当 audit_status = 2 时，资源展示系统应禁用下载，点击可查看驳回原因
6. 资源展示系统应在个人中心为已通过的资源显示缩略图（图片类为生成的 200x200px 缩略图，设计文件为格式图标）
7. 个人中心应提供审核状态筛选按钮（全部/审核中/已通过/已驳回），默认显示"全部"

### 需求 11: 审核结果通知

**用户故事:** 作为用户，我希望及时收到审核结果通知，以便了解我的资源审核进度。

#### 验收标准

1. 当 audit_status 从 0 变为 1 时，通知系统应向用户推送"您的资源《xxx》审核通过"
2. 当 audit_status 从 0 变为 2 时，通知系统应向用户推送"您的资源《xxx》审核驳回，原因：xxx"
3. 通知应通过站内信/弹窗方式推送
4. 用户应能在个人中心查看历史通知记录

### 需求 12: 审核日志记录

**用户故事:** 作为系统管理员，我希望记录所有审核状态变更，以便追溯审核历史。

#### 验收标准

1. 当 audit_status 变更时，上传系统应记录：操作人、时间戳、变更前状态、变更后状态
2. 操作人需区分"系统自动审核"和"人工审核（管理员账号）"
3. 当资源被驳回时，上传系统应记录驳回原因
4. 上传系统应将审核日志存储在数据库中以供后续查询
5. 管理员应能在后台查看审核日志列表，支持按资源ID/操作人/时间范围筛选

### 需求 13: 上传成功提示

**用户故事:** 作为用户，我希望上传后收到明确的状态提示，以便知道下一步会发生什么。

#### 验收标准

1. 当生产模式下自动审核通过时，上传系统应显示"上传成功，已自动审核通过"
2. 当生产模式下自动审核未通过时，上传系统应显示"上传成功，等待审核"
3. 当开发模式下上传成功时，上传系统应显示"上传成功"
4. 当压缩包解压失败（损坏/密码保护）时，上传系统应弹窗提示"压缩包无法自动解压（损坏/密码保护），已转入人工审核"
5. 当压缩包内无有效设计文件时，上传系统应提示"压缩包内无有效设计文件，已转入人工审核"
6. 所有上传提示均为弹窗+文字提示双展示，弹窗3秒后自动关闭，文字提示常驻至用户关闭，避免用户错过提示信息
