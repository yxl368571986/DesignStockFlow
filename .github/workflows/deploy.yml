name: CI/CD Pipeline

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
      - develop
  # Pull Requeståˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches:
      - main
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '8.x'

# ä»»åŠ¡å®šä¹‰
jobs:
  # ==================== ä»£ç è´¨é‡æ£€æŸ¥ ====================
  lint:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: è·å–pnpmç¼“å­˜ç›®å½•
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
          
      - name: è®¾ç½®pnpmç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
        
      - name: ESLintæ£€æŸ¥
        run: pnpm run lint:check
        
      - name: Prettieræ ¼å¼æ£€æŸ¥
        run: pnpm run format:check
        
      - name: TypeScriptç±»å‹æ£€æŸ¥
        run: pnpm run type-check

  # ==================== å•å…ƒæµ‹è¯• ====================
  test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: è·å–pnpmç¼“å­˜ç›®å½•
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
          
      - name: è®¾ç½®pnpmç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
        
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: pnpm run test
        
      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
        run: pnpm run test:coverage
        
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ==================== æ„å»ºæµ‹è¯• ====================
  build:
    name: æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [lint, test]
    strategy:
      matrix:
        environment: [development, production]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: è·å–pnpmç¼“å­˜ç›®å½•
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
          
      - name: è®¾ç½®pnpmç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
        
      - name: åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        run: |
          if [ "${{ matrix.environment }}" = "production" ]; then
            echo "VITE_API_BASE_URL=${{ secrets.PROD_API_BASE_URL }}" > .env.production
            echo "VITE_CDN_BASE_URL=${{ secrets.PROD_CDN_BASE_URL }}" >> .env.production
            echo "VITE_APP_TITLE=æ˜Ÿæ½®è®¾è®¡" >> .env.production
            echo "VITE_APP_ENV=production" >> .env.production
          else
            echo "VITE_API_BASE_URL=${{ secrets.DEV_API_BASE_URL }}" > .env.development
            echo "VITE_CDN_BASE_URL=${{ secrets.DEV_CDN_BASE_URL }}" >> .env.development
            echo "VITE_APP_TITLE=æ˜Ÿæ½®è®¾è®¡ï¼ˆå¼€å‘ï¼‰" >> .env.development
            echo "VITE_APP_ENV=development" >> .env.development
          fi
        
      - name: æ„å»ºé¡¹ç›®
        run: |
          if [ "${{ matrix.environment }}" = "production" ]; then
            pnpm run build:prod
          else
            pnpm run build:dev
          fi
        
      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          if [ ! -d "dist" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šdistç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šindex.htmlä¸å­˜åœ¨"
            exit 1
          fi
          echo "æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°ï¼š"
          du -sh dist
          
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.environment }}
          path: dist/
          retention-days: 7

  # ==================== éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ ====================
  deploy-dev:
    name: éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development')
    environment:
      name: development
      url: https://dev.startide-design.com
    
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist-development
          path: dist/
          
      - name: éƒ¨ç½²åˆ°å¼€å‘æœåŠ¡å™¨
        uses: easingthemes/ssh-deploy@v5
        with:
          SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.DEV_SERVER_HOST }}
          REMOTE_USER: ${{ secrets.DEV_SERVER_USER }}
          REMOTE_PORT: ${{ secrets.DEV_SERVER_PORT }}
          SOURCE: "dist/"
          TARGET: ${{ secrets.DEV_DEPLOY_PATH }}
          EXCLUDE: "/node_modules/, /.git/"
          SCRIPT_BEFORE: |
            echo "å¼€å§‹éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
            whoami
            ls -la
          SCRIPT_AFTER: |
            echo "éƒ¨ç½²å®Œæˆï¼Œé‡å¯Nginx..."
            sudo systemctl reload nginx
            echo "å¼€å‘ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            
      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          response=$(curl -s -o /dev/null -w "%{http_code}" https://dev.startide-design.com)
          if [ $response -eq 200 ]; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $response"
            exit 1
          fi
          
      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            å¼€å‘ç¯å¢ƒéƒ¨ç½²${{ job.status == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}
            åˆ†æ”¯: ${{ github.ref }}
            æäº¤: ${{ github.sha }}
            ä½œè€…: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ==================== éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ ====================
  deploy-prod:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://www.startide-design.com
    
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist-production
          path: dist/
          
      - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        uses: easingthemes/ssh-deploy@v5
        with:
          SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.PROD_SERVER_HOST }}
          REMOTE_USER: ${{ secrets.PROD_SERVER_USER }}
          REMOTE_PORT: ${{ secrets.PROD_SERVER_PORT }}
          SOURCE: "dist/"
          TARGET: ${{ secrets.PROD_DEPLOY_PATH }}
          EXCLUDE: "/node_modules/, /.git/"
          SCRIPT_BEFORE: |
            echo "å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "${{ secrets.PROD_DEPLOY_PATH }}" ]; then
              backup_dir="${{ secrets.PROD_DEPLOY_PATH }}_backup_$(date +%Y%m%d_%H%M%S)"
              echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬åˆ°: $backup_dir"
              cp -r ${{ secrets.PROD_DEPLOY_PATH }} $backup_dir
            fi
          SCRIPT_AFTER: |
            echo "éƒ¨ç½²å®Œæˆï¼Œé‡å¯Nginx..."
            sudo systemctl reload nginx
            echo "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
            cd $(dirname ${{ secrets.PROD_DEPLOY_PATH }})
            ls -t | grep "_backup_" | tail -n +6 | xargs -r rm -rf
            
      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          response=$(curl -s -o /dev/null -w "%{http_code}" https://www.startide-design.com)
          if [ $response -eq 200 ]; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $response"
            exit 1
          fi
          
      - name: æ€§èƒ½æµ‹è¯•ï¼ˆLighthouseï¼‰
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://www.startide-design.com
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²${{ job.status == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}
            åˆ†æ”¯: ${{ github.ref }}
            æäº¤: ${{ github.sha }}
            ä½œè€…: ${{ github.actor }}
            ç¯å¢ƒ: https://www.startide-design.com
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          
      - name: åˆ›å»ºGitHub Release
        if: success() && github.ref == 'refs/heads/main'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## ğŸ‰ ç”Ÿäº§ç¯å¢ƒå‘å¸ƒ
            
            **éƒ¨ç½²æ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}
            **æäº¤ä½œè€…**: ${{ github.actor }}
            **æäº¤SHA**: ${{ github.sha }}
            
            ### å˜æ›´å†…å®¹
            æŸ¥çœ‹å®Œæ•´å˜æ›´: https://github.com/${{ github.repository }}/compare/v${{ github.run_number - 1 }}...v${{ github.run_number }}
          draft: false
          prerelease: false

  # ==================== å®‰å…¨æ‰«æ ====================
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
        
      - name: è¿è¡Œnpm audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true
        
      - name: ä¾èµ–æ¼æ´æ‰«æ
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          
      - name: ä»£ç å®‰å…¨æ‰«æ
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript
          
      - name: æ‰§è¡ŒCodeQLåˆ†æ
        uses: github/codeql-action/analyze@v3

  # ==================== æ€§èƒ½ç›‘æ§ ====================
  performance-check:
    name: æ€§èƒ½æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist-production
          path: dist/
          
      - name: å®‰è£…Lighthouse CI
        run: npm install -g @lhci/cli
        
      - name: è¿è¡ŒLighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          
      - name: æ£€æŸ¥åŒ…ä½“ç§¯
        run: |
          echo "æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°..."
          total_size=$(du -sb dist | cut -f1)
          max_size=$((200 * 1024 * 1024)) # 200MB
          
          if [ $total_size -gt $max_size ]; then
            echo "âŒ æ„å»ºäº§ç‰©è¿‡å¤§: $(($total_size / 1024 / 1024))MB (é™åˆ¶: 200MB)"
            exit 1
          else
            echo "âœ… æ„å»ºäº§ç‰©å¤§å°åˆç†: $(($total_size / 1024 / 1024))MB"
          fi
          
          # æ£€æŸ¥ä¸»è¦chunkå¤§å°
          echo "ä¸»è¦chunkå¤§å°ï¼š"
          find dist/js -name "*.js" -type f -exec du -h {} \; | sort -rh | head -10
